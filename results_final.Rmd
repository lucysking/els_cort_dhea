---
title             : "Cortisol-DHEA coupling across the pubertal transition: Associations with threat-related adversity"
shorttitle        : "Title"

author: 
  - name          : "Lucy S. King"
    affiliation   : "1"
    corresponding : yes    # Define only one corresponding author
    address       : "Postal address"
    email         : "lucyking@stanford.edu"
  - name          : "Madelaine Graber"
    affiliation   : "1"
  - name          : "Natalie L. Colich"
    affiliation   : "2"
  - name          : "Ian H. Gotlib"
    affiliation   : "1"

affiliation:
  - id            : "1"
    institution   : "Stanford University"
  - id            : "2"
    institution   : "Harvard University"

authornote: |
  Add complete departmental affiliations for each author here. Each new line herein must be indented, like this line.

  Enter author note here.

abstract: |
  One or two sentences providing a **basic introduction** to the field,  comprehensible to a scientist in any discipline.
  
  Two to three sentences of **more detailed background**, comprehensible  to scientists in related disciplines.
  
  One sentence clearly stating the **general problem** being addressed by  this particular study.
  
  One sentence summarizing the main result (with the words "**here we show**" or their equivalent).
  
  Two or three sentences explaining what the **main result** reveals in direct comparison to what was thought to be the case previously, or how the  main result adds to previous knowledge.
  
  One or two sentences to put the results into a more **general context**.
  
  Two or three sentences to provide a **broader perspective**, readily comprehensible to a scientist in any discipline.
  
  <!-- https://tinyurl.com/ybremelq -->
  
keywords          : "keywords"
wordcount         : "X"

bibliography      : ["r-references.bib"]

floatsintext      : no
figurelist        : no
tablelist         : no
footnotelist      : no
linenumbers       : yes
mask              : no
draft             : no

documentclass     : "apa6"
classoption       : "man"
output            : papaja::apa6_word
---


```{r setup, include = FALSE}
#Libraries
library(papaja)
library(tidyverse)
library(lme4)
library(lmerTest)
library(modelr)
library(sjstats)
#library(olsrr)
library(broom)
library(haven)
library(corrr)
library(ggcorrplot)
library(corrplot)

#Files 
cd_lf_all_file <- "~/Desktop/ELS/cort_dhea/data/data_final/cort_dhea_all_20190509.csv"
cd_lf_file <- "~/Desktop/ELS/cort_dhea/data/data_final/cort_dhea_final_20190509.csv"
cd_wf_all_file <- "~/Desktop/ELS/cort_dhea/data/data_final/cort_dhea_all_wf_20190509.csv"
cd_wf_file <- "~/Desktop/ELS/cort_dhea/data/data_final/cort_dhea_final_wf_20190509.csv"
els_file <- "~/Desktop/ELS/stress_data/data/els_severity_scores_20190221.csv"
demo_file <- "~/Desktop/ELS/cort_dhea/data/data_final/demo.csv"
tanner_file <- "~/Desktop/ELS/cort_dhea/data/data_final/tanner_t1t2.csv"

#Themes
theme_set(theme_apa())

#Functions
format_pval <- function(pval, digits = 3){
  pval <- str_replace(round(signif(pval), digits), "0.", ".")
  pval <- if_else(pval == 0, "<.001", paste0("=", pval))
  return(pval)
}

format_lm_df <- function(mod) {
  df <- broom::tidy(mod)
  
  df %>% 
    gather(key, value, estimate:p.value) %>% 
    unite(new, term, key) %>% 
    spread(new, value)
}
```

```{r analysis-preferences}
# Seed for random number generation
set.seed(42)
knitr::opts_chunk$set(cache.extra = knitr::rand_seed)
```

```{r read in data}
cd_wf_all <-
  read_csv(cd_wf_all_file)

cd_wf_clean <-
  read_csv(cd_wf_file) %>% 
  mutate(
    male = as.factor(male),
    medication_t1 = as.factor(medication_t1),
    medication_t2 = as.factor(medication_t2)
  )

cd_all <- 
  read_csv(cd_lf_all_file) %>% 
  mutate(
    timepoint = as.factor(timepoint)
  )

cd_clean <- 
  read_csv(cd_lf_file) %>% 
  mutate(
    timepoint = as.factor(timepoint),
    male = as.factor(male),
    medication_binary = as.factor(medication_binary)
  )
```

# Methods

## Participants

```{r participants}
distinct_IDs_timepoint <-
  cd_clean %>% 
  group_by(timepoint) %>% 
  summarise(
   n_distinct(ELS_ID)
  )

distinct_IDs_all <- 
  cd_clean_id <-
  cd_clean %>% 
  distinct(ELS_ID) %>% 
  mutate(
    included = 1
  )
```

```{r missing_data_compare, include=FALSE}
all_els_demo <-
  read_csv(els_file) %>% 
  select(ELS_ID, sumsev_threat_t1, sumsev_threat_t2) %>% 
  left_join(
    read_csv(demo_file, na = c("999", "888")) %>% 
      filter(timepoint == "T1"),
    by = "ELS_ID"
  ) %>% 
  left_join(distinct_IDs_all, by = "ELS_ID") %>% 
  mutate(
    included = if_else(
      is.na(included), 0, included
    )
  ) %>% 
  mutate_at(
    vars(bmi, inr_t1),
    as.double
  ) %>% 
  left_join(
    read_csv(tanner_file) %>% 
      filter(timepoint == "T1", early_puberty == TRUE) %>% 
      distinct(ELS_ID, tanner_av, .keep_all = TRUE),
    by = "ELS_ID"
  ) %>% 
  distinct(ELS_ID, sumsev_threat_t1, .keep_all = TRUE)

all_els_demo %>% 
  group_by(included) %>% 
  summarise_at(
    vars(
      sumsev_threat_t1,
      sumsev_threat_t2,
      inr_t1,
      bmi,
      tanner_av
    ),
    list(~mean(., na.rm = TRUE))
  )
  
t.test(sumsev_threat_t1 ~ included, data = all_els_demo)
t.test(sumsev_threat_t2 ~ included, data = all_els_demo)
t.test(bmi ~ included, data = all_els_demo)
t_test_inr_included <- t.test(inr_t1 ~ included, data = all_els_demo)
t.test(tanner_av ~ included, data = all_els_demo)
```

```{r demographics_1, include=FALSE}
cd_descriptives <- 
  cd_clean %>% 
  filter(timepoint == "T1") %>% 
  group_by(male) %>% 
  summarise_at(
    vars(
      child_age, 
      tanner_av,
      bmi, 
      cort_clean,
      dhea_clean,
      test_clean,
      inr_t1,
      sumsev_threat_t1,
      sumsev_threat_t2
    ),
    list(~sum(!is.na(.)))
  ) %>% 
  gather(variable, n, child_age:sumsev_threat_t2) %>% 
  rename(n_T1 = n) %>% 
  left_join(
    cd_clean %>% 
      filter(timepoint == "T2") %>% 
      group_by(male) %>% 
      summarise_at(
        vars(
          child_age, 
          tanner_av,
          bmi, 
          cort_clean,
          dhea_clean,
          test_clean,
          inr_t1,
          sumsev_threat_t1,
          sumsev_threat_t2
        ),
        list(~sum(!is.na(.)))
      ) %>% 
      gather(variable, n, child_age:sumsev_threat_t2) %>% 
      rename(n_T2 = n),
    by = c("variable", "male")
  ) %>% 
  left_join(
    cd_clean %>% 
      filter(timepoint == "T1") %>% 
      group_by(male) %>% 
      summarise_at(
        vars(
          child_age, 
          tanner_av,
          bmi, 
          cort_clean,
          dhea_clean,
          test_clean,
          inr_t1,
          sumsev_threat_t1,
          sumsev_threat_t2
        ),
        list(~mean),
        na.rm = TRUE
      ) %>% 
      gather(variable, Mean, child_age:sumsev_threat_t2) %>% 
      rename(Mean_T1 = Mean),
    by = c("variable", "male")
  ) %>% 
  left_join(
    cd_clean %>% 
      filter(timepoint == "T2") %>% 
      group_by(male) %>% 
      summarise_at(
        vars(
          child_age, 
          tanner_av,
          bmi, 
          cort_clean,
          dhea_clean,
          test_clean,
          inr_t1,
          sumsev_threat_t1,
          sumsev_threat_t2
        ),
        list(~mean),
        na.rm = TRUE
      ) %>% 
      gather(variable, Mean, child_age:sumsev_threat_t2) %>% 
      rename(Mean_T2 = Mean),
    by = c("variable", "male")
  ) %>% 
  left_join(
    cd_clean %>% 
      group_by(male) %>% 
      filter(timepoint == "T1") %>% 
      summarise_at(
        vars(
          child_age, 
          tanner_av,
          bmi, 
          cort_clean,
          dhea_clean,
          test_clean,
          inr_t1,
          sumsev_threat_t1,
          sumsev_threat_t2
        ),
        list(~sd),
        na.rm = TRUE
      ) %>% 
      gather(variable, SD, child_age:sumsev_threat_t2) %>% 
    rename(SD_T1 = SD),
    by = c("variable", "male") 
  ) %>% 
  left_join(
    cd_clean %>% 
      group_by(male) %>% 
      filter(timepoint == "T2") %>% 
      summarise_at(
        vars(
          child_age, 
          tanner_av,
          bmi, 
          cort_clean,
          dhea_clean,
          test_clean,
          inr_t1,
          sumsev_threat_t1,
          sumsev_threat_t2
        ),
        list(~sd),
        na.rm = TRUE
      ) %>% 
      gather(variable, SD, child_age:sumsev_threat_t2) %>% 
      rename(SD_T2 = SD),
    by = c("variable", "male")
  ) %>% 
  mutate_at(
    vars(starts_with("Mean"), starts_with("SD")),
    list(~round), digits = 2
  ) %>% 
  unite("T1 Mean (SD)", Mean_T1, SD_T1) %>% 
  unite("T2 Mean (SD)", Mean_T2, SD_T2)  %>% 
  mutate_at(
    vars(`T1 Mean (SD)`, `T2 Mean (SD)`),
    list(
      ~str_replace(
        .,
        "_", " ("
      )
    )
  ) %>% 
  mutate_at(
    vars(`T1 Mean (SD)`, `T2 Mean (SD)`),
    list(
      ~paste0(. , ")")
    )
  ) %>% 
  select(
    Measure = variable,
    Sex = male,
    everything()
  ) %>% 
  mutate(
    Sex = recode(
      Sex,
      "0" = "Female",
      "1" = "Male"
    )
  )
```

```{r descriptives_2_table}
race_ethn_descriptives <- 
  cd_clean %>% 
  filter(timepoint == "T1") %>% 
  group_by(male) %>% 
  count(
    race_pr
  ) %>% 
  mutate(
    race_pr = case_when(
      race_pr == 1 ~ "Caucasian",
      race_pr == 2 ~ "African American",
      race_pr == 3 ~ "Hispanic",
      race_pr == 4 ~ "Asian",
      race_pr == 5 ~ "Biracial",
      race_pr == 6 ~ "Other",
      TRUE ~ "Not reported"
    )
  ) %>% 
  rename(measure = race_pr) %>% 
  arrange(desc(n)) %>% 
  ungroup() %>% 
  rename(
    Measure = measure,
    n_T1 = n,
    Sex = male
  ) %>% 
  mutate(
    Sex = recode(
      Sex,
      "0" = "Female",
      "1" = "Male"
    )
  ) %>% 
  select(
    Measure,
    everything()
  )

cd_descriptives <-
  cd_descriptives %>% 
  bind_rows(race_ethn_descriptives)
```

```{r demographics_1_table}
cd_descriptives %>% 
  knitr::kable()
```

```{r demographics_sex, include=FALSE}
cd_clean %>% 
  filter(timepoint == "T1") %>% 
  count(male) %>% 
  mutate(prop = round(n / sum(n), 2))
```

```{r count_lowincome, include=FALSE}
cd_clean %>% 
  distinct(ELS_ID, inr_t1) %>% 
  count(inr_t1 < 1) %>% 
  mutate(
    prop = n / sum(n)
  )
```

Participants were 214 early adolescents and their parents who were recruited from the community to participate in a longitudinal study of the psychobiological effects of early life stress across the transition from earlier puberty (Time 1 [T1]) to later puberty (Time 2 [T2]) (CITE). Participants were recruited from the geographic area surrounding Stanford University through local and media postings. Inclusion criteria were that the adolescents were between 9 and 13 years of age and proficient in spoken English. Exclusion criteria at T1 included a history of major neurological or medical illnesses, severe learning disabilities that would affect comprehension of study procedures, and, for females, the onset of menses. In addition, participants were selected based on their eligibility to participate in a magnetic resonance imaging (MRI) scan (e.g. no metal implants or braces). 
Given the focus of the study on pubertal development, males and females were matched on self-reported pubertal stage (see “Pubertal Stage,” below). To be included in the current analyses, we required participants to be in early puberty at T1 (Tanner stages 1-3; decribed below), leading to the exclusion of 14 participants. In addition, we excluded 24 participants who did not provide a waking saliva sample that yielded a value for cortisol or DHEA at either T1 or T2 (see Supplement for detailed information on missing data). Therefore, the final sample for the current analyses included 176 adolescents (55% female), 171 of whom provided data at T1 and 140 of whom provided data at T2. Descriptive statistics for the final analyzable sample are presented in Table 1. There were no significant differences between those included in the final sample and those not included in the final sample in terms of threat-related adversity at T1, tanner stage at T1, or body mass index (BMI) at T1; however, those included included in the final sample had marginally significantly higher family income-to-needs ratios than those not included _t_(`r t_test_inr_included$parameter`)=`r t_test_inr_included$statistic`, _p_`r format_pval(t_test_inr_included$p.value)`).

## Procedure
```{r interval}
interval_summary <- 
  cd_wf_clean %>% 
  summarise(
    mean_interval = mean(interval_yr, na.rm = TRUE),
    sd_interval = sd(interval_yr, na.rm = TRUE),
    min_interval = min(interval_yr, na.rm = TRUE),
    max_interval = max(interval_yr, na.rm = TRUE)
  )

mean_interval <- interval_summary$mean_interval
sd_interval <- interval_summary$sd_interval
min_interval <- interval_summary$min_interval
max_interval <- interval_summary$max_interval
```

The Stanford University Institutional Review Board approved the protocol for this study. In an initial telephone call, research staff provided information about the protocol to families and screened participants for inclusion/exclusion criteria. We then invited eligible families to attend the a laboratory session during which staff obtained consent from parents and assent from adolescents. In this session, children reported their Tanner stages, and both parents and children completed interview and questionnaire measures about the child and family. At the end of the session, staff provided families with kits and instructions to collect  saliva samples at home for the assessment of waking hormone levels. Families returned the samples to the laboratory at a subsequent visit. These procedures were repeated at a T2 laboratory session that occured an average of 2 years later (mean[SD]=`r mean_interval`[`r sd_interval`]; range: `r min_interval`-`r max_interval`). 

## Measures
```{r tanner}
range_tanner <- 
  cd_clean %>% 
  filter(timepoint == "T2") %>% 
  summarise(
    min_tanner = min(tanner_av, na.rm = TRUE),
    max_tanner = max(tanner_av, na.rm = TRUE)
  )
```

__Pubertal stage.__ In order to match males and females based on pubertal stage at Time 1, we measured pubertal development using self-report Tanner staging (Marshall and Tanner, 1968; Marshall & Tanner, 1970; Morris and Udry, 1980). Tanner staging scores are correlated with physicians’ physical examinations of pubertal development (Coleman & Coleman, 2002; Shirtcliff et al., 2009). Participants reported their pubertal stage by selecting how closely their pubic hair and breast/testes resembled an array of schematic drawings on a scale of 1 (prepubertal) to 5 (postpubertal). For the purposes of this study, we used the average of the pubic hair and breast/testes Tanner scores to index overall pubertal development (Dorn et al., 2006). Average Tanner scores ranged from 1-3 at T1 and from 1-5 at T2.

__Severity of threat-related adversity.__ As previously described (CITE), at T1, participants were interviewd about their lifetime exposure to 30+ types of stressors using a modified version of the Traumatic Events Screening Inventory for Children (Ribbe, 1996). A panel of three coders, blind to the children’s reactions and behaviors during the interview, then rated the objective severity of each type of stressor endorsed on a scale of (0 = non-event or no impact; 4 = extremely severe impact; ICC = 0.99). To quantify the severity of threat-related adversity, we summed the maximum objective severity ratings for the events in Table 2. We selected these events to be consistent with CITE SHERIDAN MCLAUGHLIN'S definition of threat as "the presence of an atypical (i.e., unexpected) experience characterized by actual or threatened death, injury, sexual violation, or other harm to one’s physical integrity" (p. X). 

```{r included_ids}
included_IDs <- 
  cd_clean %>% 
  distinct(ELS_ID) %>% 
  pull()
```

```{r stress_table}
read_csv(els_file) %>% 
  filter(ELS_ID %in% included_IDs) %>% 
  select(
    `Community verbal conflict ` = comm_arg_t1,
    `Community instability` = comm_inst_t1,
    `Community violence` = comm_phys_t1,
    Bullying = bully_t1,
    `Threats of domestic violence` = thrt_domvio_t1,
    `Threats of physical abuse` = thrt_phys_ab_t1,
    `Kidnapping` = kidnap_t1,
    `Family verbal conflict` =  parent_arg_t1,
    `Domestic violence` = dom_viol_t1,
    `War or terrorism` = war_terr_t1,
    `Emotional abuse` = emo_ab_t1,
    `Physical abuse` = phys_ab_t1,
    `Sexual abuse` = sex_ab_t1,
    `Witness sexual abuse` = wit_sexab_t1, 
    `Mugging or robbery` = mug_rob_t1
  ) %>% 
  gather(type, endorsed) %>% 
  count(type, endorsed) %>% 
  group_by(type) %>% 
  mutate(
    `Percent endorsed` = round(((n / sum(n)) * 100), 0)
  ) %>% 
  rename(Type = type) %>% 
  filter(endorsed == 1) %>% 
  arrange(desc(`Percent endorsed`)) %>% 
  select(-endorsed) %>% 
  knitr::kable()
```

__Family income-to-needs ratio.__ As a measure of deprivation-related adversity, we calculated the income-to-needs ratio for each child’s family. The parent who accompanied the child to the laboratory session reported total family income over the previous 12 months and the number of people in their family. We collected income data in bins, with parents reporting income on a 10-point scale of <$5,000 to ≥ $150,000. To calculate the income-to-needs ratio, we divided the midpoint of the endorsed income bin by the low-income limit for Santa Clara county (80% of the median income) determined by the Department of Housing and Urban Development based on the number of people in the household (https://www.huduser.gov/portal/datasets/il/il2017/2017summary.odn). Based on having an income-to-needs ratio < 1, 26% (n=45) adolescents were “low-income.” 

__Waking cortisol and DHEA.__ Salivary hormonal assays were conducted for cortisol, DHEA, and testosterone At each time-point, participants were asked to provide a saliva sample through passive drool immediately upon awakening (prior to eating breakfast or brushing teeth). Participants recorded collection time and placed the saliva samples in their home freezer after collection. After participants returned the samples to the laboratory, samples were transferred to a -20°C freezer in the Psychology Department at Stanford University. The samples were then shipped on dry ice to Salimetrics, LLC (State College, PA), where they were assayed for salivary cortisol, DHEA, and testosterone using a high sensitivity enzyme immunoassays (Cat. No. 1-3002 for cortisol; Cat. No. 1-1202 for DHEA; Cat. No. 1-2402 for testosterone). The assay for cortisol used 25 μl of saliva per determination, had a lower limit sensitivity of .0007 µg/dL and a standard curve range from .012-3.0 µg/dL. The assay for DHEA used 50 μl of saliva per determination, had a lower limit of sensitivity of 5 pg/mL, and a standard curve range from 10.2-1000 pg/mL. The assay for tesosterone used 25 μl of saliva per determination, had a lower limit of sensitivity of 1 pg/mL, and a standard curve range from 6.1-600 pg/mL The average intra- and inter-assay coefficients variation for cortisol were 4.60% and 6.00%, respectively. The average intra- and inter-assay coefficients variation for DHEA were 5.55% and 8.20%, respectively. The average intra- and inter-assay coefficients variation for testosterone were 4.60% and 9.85%, respectively.  We winsorized  cortisol, DHEA, and testosterone values that were +/- 3SD from the mean (within time point and sex), and then natural log-transformed the values at each time point to correct for positive skew. In addition, we calculated the slopes of cortisol, DHEA, and testosterone from T1 to T2 as follows: (hormone T2 - hormone T2) / T1-T2 interval in years. Contemporaneous with saliva samples, participants reported their use of over-the-counter and prescription medications, including corticosteroids.

## Data analysis
All analyses were conducted in R (CITE). The criterion for significance was set at ALPHA=.05. 

First, we used multi-level modeling (also known as mixed-effects or hierarchical linear modeling CITE) to test the hypotheses that cortisol and DHEA are positively correlated in both earlier and later puberty and that correlations are stronger in later pubery than in earlier puberty. We implemented this model using the function “lmer” in the “lme4” package, and we used the package “lmerTest” for calculation of degrees of freedom and p-values (CITE Bates, Machler, Bolker, & Walker, 2014; Kuznetsova, Brockhoff, & Christensen, 2016). This model was fit as follows:

  Equation 1:
  
  R code: lmer(cortisol ~ DHEA * time point + (1|subject ID))

ADD INFO ABOUT MODEL. A statistically significant interaction indicates that the association between DHEA and cortisol at T1 is significantly different from the association at T2. In the presence of a significant interaction, we probed the simple effects by examining the associations between DHEA and cortisol at T1 and T2, respectively. 

Second, we used ordinary least squares (OlS) linear regression to test the hypothesis that increases in DHEA from T1 to T2 are associated with increases in cortisol from T1 to T2, and to investigate the association of the severity of threat-related adversity with longitudinal coupling of DHEA and cortisol. We implemented this model using the function "lm" in the "stats" package as follows:

  Equation 2: 
  
  R code: lm(cortisol slope ~ DHEA slope * threat severity + T1 cortisol + T1 DHEA)
  
ADD INFO ABOUT MODEL. A  significant main effect of DHEA slope indicates that longitudinal changes in DHEA are associated with longitudinal changes in cortisol. A significant interaction between DHEA slope and threat severity indicates that the association between longitudinal changes in DHEA and longitudinal changes in cortisol depends on the level of threat severity. In the presence of a significant interaction, we probed the simple effects by examining the association between the DHEA slope and the cortisol slope at +/- 1SD from the mean of threat severity. 

To examine the impact of potential covariates, including interval in years between T1 and T2, use of medication (coded 0/1), sex (coded 0/1), BMI, age at T1, and threat severity at T2, on the effects of interest we first conducted formal model fitting (CITE) in which we tested whether each covariates significantly improved the model fit using likelihood ratio tests (multi-level models) or analyses of variance (OLS regression). Next, we conducted sensitivity analyses including the covariates that improved model fit. In addition, we tested separate models in which we removed observations from participants who were taking any medications at the time of hormone collection. 

Given potential differences in production and function of cortisol and pubertal hormones in boys and girls, we additionally ran the models specified in Equations 1-2 separately within boys and girls. Finally, to clarify the role of threat-related adversity versus deprivation-related adversity in the longitudinal coupling of cortisol and DHEA, we tested whether income-to-needs ratio interacted with with change in DHEA from T1 to T2 (i.e., DHEA slope) to explain change in cortisol from T1 to T2 (i.e., cortisol slope); specifically, we ran a separate model in which we replaced "threat severity" with family income-to-needs ratio in Equation 2. 

# Results
## Sample characteristics
```{r time_ttests}
t_test_tanner <- t.test(cd_wf_clean$tanner_t2, cd_wf_clean$tanner_t1, paired = TRUE)

t_test_bmi <- t.test(cd_wf_clean$bmi_t2, cd_wf_clean$bmi_t1, paired = TRUE)

t_test_cort <- t.test(cd_wf_clean$cort_clean_t2, cd_wf_clean$cort_clean_t1, paired = TRUE)

t_test_dhea <- t.test(cd_wf_clean$dhea_clean_t2, cd_wf_clean$dhea_clean_t1, paired = TRUE)

t_test_test <- t.test(cd_wf_clean$test_clean_t2, cd_wf_clean$test_clean_t1, paired = TRUE)

t_test_threat <- t.test(cd_wf_clean$sumsev_threat_t1, cd_wf_clean$sumsev_threat_t2, paired = TRUE)

```

```{r sex_differences}
# sex differences: stress
t_test_stress_T1 <- t.test(cd_clean$sumsev_threat_t1 ~ cd_clean$male)
t_test_stress_T2 <- t.test(cd_clean$sumsev_threat_t2 ~ cd_clean$male)

#sex differences interval
t_test_interval <- t.test(cd_clean$interval_yr ~ cd_clean$male)

# sex differences: tanner
tanner_sex_mod <-
  lmer(
    tanner_av ~
      male * timepoint +
      (1|ELS_ID),
    data = cd_clean
  )

# sex differences: BMI
bmi_sex_mod <-
  lmer(
    bmi ~
      male * timepoint +
      (1|ELS_ID),
    data = cd_clean
  )

# sex differences: DHEA
dhea_sex_mod <-
  lmer(
    dhea_clean ~
      male * timepoint +
      (1|ELS_ID),
    data = cd_clean
  )


contrasts(cd_clean$timepoint) = c(0, 1) #T1 is baseline
contrasts(cd_clean$male) = c(0, 1) #Female is baseline

# sex differences: cortisol
cort_sex_mod_1 <-
  lmer(
    cort_clean ~
      male * timepoint +
      (1|ELS_ID),
    data = cd_clean
  )

std_beta_cort_sex_mod_1 <- std_beta(cort_sex_mod_1)

contrasts(cd_clean$male) = c(1, 0) #Male is baseline

cort_sex_mod_2 <-
  lmer(
    cort_clean ~
      male * timepoint +
      (1|ELS_ID),
    data = cd_clean
  )

std_beta_cort_sex_mod_2 <- std_beta(cort_sex_mod_2)

# sex differences: testosterone
contrasts(cd_clean$timepoint) = c(0, 1) #T1 is baseline
contrasts(cd_clean$male) = c(0, 1) #Female is baseline

test_sex_mod_1 <-
  lmer(
    test_clean ~
      male * timepoint +
      (1|ELS_ID),
    data = cd_clean
  )

std_beta_test_sex_mod_1 <- std_beta(test_sex_mod_1)

contrasts(cd_clean$timepoint) = c(1, 0) #T2 is baseline

test_sex_mod_2 <-
  lmer(
    test_clean ~
      male * timepoint +
      (1|ELS_ID),
    data = cd_clean
  )


std_beta_cort_sex_mod_2 <- std_beta(test_sex_mod_2)

contrasts(cd_clean$timepoint) = c(0, 1) #T1 is baseline
contrasts(cd_clean$male) = c(1, 0) #Male is baseline

test_sex_mod_3 <-
  lmer(
    test_clean ~
      male * timepoint +
      (1|ELS_ID),
    data = cd_clean
  )

std_beta_cort_sex_mod_3 <- std_beta(test_sex_mod_3)
```

```{r plot_sexdifferences}
cd_clean %>% 
  select(timepoint, male, cort_clean:test_clean) %>% 
  gather(hormone, value, cort_clean:test_clean) %>% 
  mutate(
    hormone = recode(
      hormone,
      cort_clean = "log Cortisol\n(µg/dL)",
      dhea_clean = "log DHEA\n(pg/mL)",
      test_clean = "log Testosterone\n(pg/mL)"
    )
  ) %>% 
  ggplot(aes(timepoint, value, fill = male)) +
  geom_violin(draw_quantiles = .5, alpha = 3/4) +
  scale_y_continuous(breaks = seq.int(-4, 8, 1), expand = c(0, 1)) +
  scale_fill_manual(
    values = c("darkred", "darkblue"),
    labels = c("Girls", "Boys")
  ) +
  theme_apa(box = TRUE) +
  labs(
    x = NULL,
    y = NULL,
    fill = NULL
  ) +
  facet_wrap(.~hormone, scales = "free") 

ggsave(
  "~/Desktop/ELS/cort_dhea/cort_dhea_sync/sexdiff_hormones.png",
  width = 7,
  height = 5
  )
```


```{r medication_counts}
count_medications <-
  cd_clean %>% 
  group_by(timepoint) %>% 
  count(medication_binary) %>%
  mutate(prop = round(n / sum(n), 2))

count_corticosteroids <-
  cd_clean %>% 
  group_by(timepoint) %>% 
  count(corticosteroid) %>%
  mutate(prop = round(n / sum(n), 2))

count_birthcontrol <-
  cd_clean %>% 
  group_by(timepoint) %>% 
  count(birth_control) %>%
  mutate(prop = round(n / sum(n), 2))
```

```{r correlations, include=TRUE}
cd_wf_clean %>% 
  select(
    sumsev_threat_t1,
    sumsev_threat_t2,
    inr_t1,
    tanner_t1,
    tanner_t2,
    bmi_t1,
    bmi_t2,
    child_age_t1,
    interval_yr,
    cort_clean_t1,
    cort_clean_t2,
    dhea_clean_t1,
    dhea_clean_t2,
    test_clean_t1,
    test_clean_t2
  ) %>% 
  correlate() %>% 
  fashion()

cor.test(cd_wf_clean$cort_clean_t2, cd_wf_clean$tanner_t2)
```



We present characteristics of the study sample in Table 1. At T1, 15% of adolescents reported the use of medications contemporaneous with saliva samples, with 4% reporting the use of a corticosteroid. At T2 22% of adolescents reported the use of medications, with 6% reporting the use of a corticosteroid. None of the girls reported the use of hormonal birth control at either time point. Pearson's bivariate correlations indicated that threat severity at T1 was not associated with child age, pubertal stage, BMI, the time interval between the T1 and T2 assessments, or T1 or T2 cortisol, DHEA or testosterone, but was positively correlated with threat severity at T2 ( _r_=.40) and negatively correlated with family income-to-needs ratio ( _r_=-.22). None of the hormones at either time-point were associated with the interval between T1 and T2 or pubertal stage at T1; however, DHEA and testosterone at T2 were associated with pubertal stage at T2 ( _r_=.38 and _r_=.37, respectively). 


As expected, self-reported pubertal stage and BMI significantly increased from T1 to T2 (__pubertal stage:__ _t_(`r  t_test_tanner$parameter`)=`r t_test_tanner$statistic`, _p_`r format_pval(t_test_tanner$p.value)`; __BMI:__ _t_(`r t_test_bmi$parameter`)=`r t_test_bmi$statistic`, _p_`r format_pval(t_test_bmi$p.value)`). Paired _t_-tests indicated that both cortisol, DHEA, and testosterone significantly increased from T1 to T2 (__cortisol:__ _t_(`r t_test_cort$parameter`)=`r t_test_cort$statistic`, _p_`r format_pval(t_test_cort$p.value)`; __DHEA:__ _t_(`r t_test_dhea$parameter`)=`r t_test_dhea$statistic`, _p_`r format_pval(t_test_dhea$p.value)`; __testosterone:__ _t_(`r t_test_test$parameter`)=`r t_test_test$statistic`, _p_`r format_pval(t_test_test$p.value)`). Threat severity was significantly higher at T1 than at T2 (_t_(`r t_test_threat$parameter`)=`r t_test_threat$statistic`, _p_`r format_pval(t_test_threat$p.value)`), but this was expected given that T1 threat severity captured lifetime experiences up to the T1 assessment whereas T2 threat severity captured only those experiences occurring between T1 and T2. 

Boys and girls did not differ significantly in the severity of threat-related adversity at T1 or T2, the time interval between the T1 and T2 assessments, nor in levels of pubertal stage, BMI, or DHEA at either time-point or increases in these measures from T1 to T2. We did, however, observe sex differences in testosterone and cortisol. At T1, boys and girls did not differ significantly in levels of testosterone (β=`r std_beta_test_sex_mod_1[1,2]`, SE=`r std_beta_test_sex_mod_1[1,3]`, _t_(270.06)=1.38, _p_=.167, 95% CI[`r std_beta_test_sex_mod_1[1,4]`, `r std_beta_test_sex_mod_1[1,5]`]); however, at T2, boys had significantly higher testosterone than did girls (β=`r std_beta_cort_sex_mod_2[1,2]`, SE=`r std_beta_cort_sex_mod_2[1,3]`, _t_(287.30)=8.60, _p_<.001, 95% CI[`r std_beta_cort_sex_mod_2[1,4]`, `r std_beta_cort_sex_mod_2[1,5]`]). Athough both boys and girls exhibited significant increases in testosterone from T1 to T2, increases were larger for boys (β=`r std_beta_cort_sex_mod_3[2,2]`, SE=`r std_beta_cort_sex_mod_3[2,3]`, _t_(145.98)=11.41, _p_<.001, 95% CI[`r std_beta_cort_sex_mod_3[2,4]`, `r std_beta_cort_sex_mod_3[2,5]`]) than for girls (β=`r std_beta_test_sex_mod_1[2,2]`, SE=`r std_beta_test_sex_mod_1[2,3]`, _t_(146.43)=2.32, _p_<.021, 95% CI[`r std_beta_test_sex_mod_1[2,4]`, `r std_beta_test_sex_mod_1[2,5]`]). At T1, girls had significantly higher cortisol than did boys (β=`r std_beta_cort_sex_mod_2[1,2]`, SE=`r std_beta_cort_sex_mod_2[1,3]`, _t_(276.67)=2.83, _p_=.005, 95% CI[`r std_beta_cort_sex_mod_2[1,4]`, `r std_beta_cort_sex_mod_2[1,5]`]). Further, boys evidenced overall increases in cortisol from T1 to T2 (β=`r std_beta_cort_sex_mod_2[2,2]`, SE=`r std_beta_cort_sex_mod_2[2,3]`, _t_(138.03)=4.09, _p_<.001, 95% CI[`r std_beta_cort_sex_mod_2[2,4]`, `r std_beta_cort_sex_mod_2[2,5]`]), whereas girls did not (β=`r std_beta_cort_sex_mod_1[2,2]`, SE=`r std_beta_cort_sex_mod_1[2,3]`, _t_(149.51)=-0.36, _p_=.720, 95% CI[`r std_beta_cort_sex_mod_1[2,4]`, `r std_beta_cort_sex_mod_1[2,5]`]).


## Associations between DHEA and cortisol in earlier versus later puberty

```{r t1t2mod_modelfit, warning=FALSE, include=FALSE}
contrasts(cd_clean$timepoint) = c(-1, 1) # effect code timepoint
contrasts(cd_clean$medication_binary) = c(-1, 1) # effect code medication
contrasts(cd_clean$male) = c(-1, 1) # effect code sex

t1t2_mod1_tp <- lmer(
  scale(cort_clean) ~ 
    scale(dhea_clean) * timepoint +
    (1 | ELS_ID),
  data = cd_clean
)

# collection time_________________________________
cd_clean_time <-
  cd_clean %>% 
  filter(!is.na(time_collection))

t1t2_mod1_time <- lmer(
  scale(cort_clean) ~ 
    scale(dhea_clean) * timepoint +
    (1 | ELS_ID),
  data = cd_clean_time
)

t1t2_mod2_tp_mf1 <- lmer(
  scale(cort_clean) ~ 
    scale(dhea_clean) * timepoint +
    time_collection +
    (1 | ELS_ID),
  data = cd_clean_time
)

anova(t1t2_mod1_time, t1t2_mod2_tp_mf1)

# T1 to T2 interval________________________________
cd_clean_interval <-
  cd_clean %>% 
  filter(!is.na(interval_yr))

t1t2_mod1_int <- lmer(
  scale(cort_clean) ~ 
    scale(dhea_clean) * timepoint +
    (1 | ELS_ID),
  data = cd_clean_interval
)

t1t2_mod2_tp_mf2 <- lmer(
  scale(cort_clean) ~ 
    scale(dhea_clean) * timepoint +
    interval_yr +
    (1 | ELS_ID),
  data = cd_clean_interval
)

anova(t1t2_mod1_int, t1t2_mod2_tp_mf2)

# medication________________________________
t1t2_mod_tp_mf3 <- lmer(
  scale(cort_clean) ~ 
    scale(dhea_clean) * timepoint +
    medication_binary +
    (1 | ELS_ID),
  data = cd_clean
)
    
anova(t1t2_mod1_tp, t1t2_mod_tp_mf3)

# sex________________________________________
t1t2_mod_tp_mf4 <- lmer(
  scale(cort_clean) ~ 
    scale(dhea_clean) * timepoint +
    male +
    (1 | ELS_ID),
  data = cd_clean
)
    
anova(t1t2_mod1_tp, t1t2_mod_tp_mf4)

# bmi T1______________________________________
cd_clean_bmi <-
  cd_clean %>% 
  filter(!is.na(bmi_t1))

t1t2_mod2_bmi <- lmer(
  scale(cort_clean) ~ 
    scale(dhea_clean) * timepoint +
    (1 | ELS_ID),
  data = cd_clean_bmi
)

t1t2_mod_tp_mf5 <- lmer(
  scale(cort_clean) ~ 
    scale(dhea_clean) * timepoint +
    scale(bmi_t1) +
    (1 | ELS_ID),
  data = cd_clean_bmi
)
    
anova(t1t2_mod2_bmi, t1t2_mod_tp_mf5)

# age________________________________________
cd_clean_age <-
  cd_clean %>% 
  filter(!is.na(child_age_t1))

t1t2_mod2_age <- lmer(
  scale(cort_clean) ~ 
    scale(dhea_clean) * timepoint +
    (1 | ELS_ID),
  data = cd_clean_age
)

t1t2_mod_tp_mf6 <- lmer(
  scale(cort_clean) ~ 
    scale(dhea_clean) * timepoint +
    scale(child_age_t1) +
    (1 | ELS_ID),
  data = cd_clean_age
)
    
anova(t1t2_mod2_age, t1t2_mod_tp_mf6)
```

```{r t1t2mod, warning=FALSE, include=FALSE}
contrasts(cd_clean$timepoint) = c(0, 1) # T1 is baseline

t1t2_mod1_tp <- lmer(
  scale(cort_clean) ~ 
    scale(dhea_clean) * timepoint +
    (1 | ELS_ID),
  data = cd_clean
)

summary(t1t2_mod1_tp)

t1t2_mod1_tp_test <- lmer(
  scale(cort_clean) ~ 
    scale(dhea_clean) * timepoint +
    (1 | ELS_ID),
  data = cd_clean
)

summary(t1t2_mod1_tp_test)

#confint.merMod(t1t2_mod1_tp, method = "boot")

contrasts(cd_clean$timepoint) = c(1, 0) # T2 is baseline

t1t2_mod2_tp <- lmer(
  scale(cort_clean) ~ 
    scale(dhea_clean) * timepoint +
    (1 | ELS_ID),
  data = cd_clean
)

summary(t1t2_mod2_tp)

#confint.merMod(t1t2_mod2_tp, method = "boot")
```

```{r t1t2mod_sensitivity, warning=FALSE, include=FALSE}
contrasts(cd_clean$timepoint) = c(0, 1) # T1 is baseline

t1t2_mod1_tp_sens <- lmer(
  scale(cort_clean) ~ 
    scale(dhea_clean) * timepoint +
    scale(time_collection) +
    scale(bmi_t1) +
    (1 | ELS_ID),
  data = cd_clean
)

summary(t1t2_mod1_tp_sens)

#confint.merMod(t1t2_mod1_tp_sens, method = "boot")
```

```{r t1t2mod_corticosterid, warning=FALSE, include=FALSE}
cd_clean_nosteroid <-
  cd_clean %>% 
  filter(corticosteroid == 0)

contrasts(cd_clean_nosteroid$timepoint) = c(0, 1) # T1 is baseline

t1t2_mod1_nosteroid <- lmer(
  scale(cort_clean) ~ 
    scale(dhea_clean) * timepoint +
    (1 | ELS_ID),
  data = cd_clean_nosteroid
)

summary(t1t2_mod1_nosteroid)

#confint.merMod(t1t2_mod1_nosteroid, method = "boot")

```

```{r t1t2mod_bysex, warning=FALSE, include=FALSE}
cd_clean_boys <-
  cd_clean %>% 
  filter(male == 1)

contrasts(cd_clean_boys$timepoint) = c(0, 1) # T1 is baseline

t1t2_mod1_tp_boys <- lmer(
  scale(cort_clean) ~ 
    scale(dhea_clean) * timepoint +
    (1 | ELS_ID),
  data = cd_clean_boys
)

summary(t1t2_mod1_tp_boys)
#confint.merMod(t1t2_mod1_tp_boys, method = "boot")

contrasts(cd_clean_boys$timepoint) = c(1, 0) # T2 is baseline

t1t2_mod2_tp_boys <- lmer(
  scale(cort_clean) ~ 
    scale(dhea_clean) * timepoint +
    (1 | ELS_ID),
  data = cd_clean_boys
)

summary(t1t2_mod2_tp_boys)
#confint.merMod(t1t2_mod2_tp_boys, method = "boot")

cd_clean_girls <-
  cd_clean %>% 
  filter(male == 0)

t1t2_mod1_tp_girls <- lmer(
  scale(cort_clean) ~ 
    scale(dhea_clean) * timepoint +
    (1 | ELS_ID),
  data = cd_clean_girls
)

summary(t1t2_mod1_tp_girls)

#confint.merMod(t1t2_mod1_tp_girls, method = "boot")
```


Results of a multi-level model indicated that DHEA interacted with time point (dummy-coded) to explain cortisol (β=0.25, SE=0.11, _t_(240.78)=2.27, _p_=.024, 95% CI[0.03, 0.46]). Simple effects analyses indicated that DHEA was positively associated with cortisol at T1 (β=0.38, SE=0.07, _t_(281.03)=5.65, _p_<.001, 95% CI[0.24, 0.51]), and that the positive association between DHEA and cortisol was stronger at T2 (β=0.63, SE=0.09, _t_(278.46)=6.77, _p_<.001, 95% CI[0.46, 0.81]). 

Results of formal model fitting indicated that neither interval in years between T1 and T2, use of medication, sex, nor child age at T1 significantly improved model fit; however, BMI at T1 and time of collection marginally improved model fit. In sensitivity analyses, the interaction btween DHEA and timepoint remained significant when controlling for BMI at T1 and time of collection  (β=0.33, SE=0.11, _t_(195.93)=2.89, _p_=.005, 95% CI[0.11, 0.55]) In a separate model excluding hormone values that were collected contemporaenous with the use of corticosteroids, the interaction between DHEA and time point remained statistically significant, (β=0.24, SE=0.11, _t_(179.85)=2.06, _p_=.040, 95% CI[0.01, 0.45]).

In a separate model conducted within boys only, the interaction between DHEA and time point was larger in effect size than in the full model including both boys and girls (β=0.41, SE=0.16,  _t_(109.62)=2.61, _p_=.010, 95% CI[0.10, 0.75]). Simple effect analyses indicated that, among boys, DHEA was positively associated with cortisol at T1 (β=0.37, SE=0.09, _t_(128.83)=4.36, _p_<.001, 95% CI[0.22, 0.53]), and that the positive association between DHEA and cortisol was stronger at T2 (β=0.79, SE=0.14, _t_(126.13)=5.74, _p_<.001, 95% CI[0.53, 1.05]). In contrast, in a separate model conducted within girls only, the interaction between DHEA and timepoint was no longer significant (β=0.13, SE=0.16,  _t_(123.25)=0.84, _p_=.403, 95% CI[-0.17, 0.44]). We present the simple associations between DHEA and cortisol at T1 vs. T2 for each sex in Figure 1. 

```{r plot_t1t2_mod, warning=FALSE}
cd_clean %>% 
  ggplot(
    aes(
      dhea_clean,
      cort_clean,
      color = timepoint
    )
  ) + 
  geom_point(size = 1.5, alpha = 1/2) +
  geom_smooth(method = "lm", se = FALSE, size = 1.5) +
  scale_x_continuous(breaks = seq.int(1, 8, 1), expand = c(0, 1)) +
  scale_y_continuous(breaks = seq.int(-4, 1, 1), expand = c(0, 1)) +
  scale_color_manual(
    values = c("darkblue", "darkred"),
    labels = c("T1 (early puberty)", "T2 (late puberty)")
  ) +
  theme_apa(box = TRUE) +
  theme(legend.position = "bottom") +
  labs(
    color = NULL,
    x = "log DHEA (pg/mL)",
    y = "log Cortisol (µg/dL)"
  ) +
  facet_wrap(
    .~ male, 
    scales = "free",
    labeller = labeller(male = c("0" = "Girls", "1" = "Boys"))
  )
```

## Associations between testosterone and cortisol in earlier versus later puberty

```{r t1t2mod_modelfit_test, warning=FALSE, include=FALSE}
contrasts(cd_clean$timepoint) = c(-1, 1) # effect code timepoint
contrasts(cd_clean$medication_binary) = c(-1, 1) # effect code medication
contrasts(cd_clean$male) = c(-1, 1) # effect code sex

t1t2_mod1_tp_test <- lmer(
  scale(cort_clean) ~ 
    scale(test_clean) * timepoint +
    (1 | ELS_ID),
  data = cd_clean
)

# collection time_________________________________
t1t2_mod1_time_test <- lmer(
  scale(cort_clean) ~ 
    scale(test_clean) * timepoint +
    (1 | ELS_ID),
  data = cd_clean_time
)

t1t2_mod2_tp_mf1_test <- lmer(
  scale(cort_clean) ~ 
    scale(test_clean) * timepoint +
    time_collection +
    (1 | ELS_ID),
  data = cd_clean_time
)

anova(t1t2_mod1_time_test, t1t2_mod2_tp_mf1_test)

# T1 to T2 interval________________________________
cd_clean_interval <-
  cd_clean %>% 
  filter(!is.na(interval_yr))

t1t2_mod1_int_test <- lmer(
  scale(cort_clean) ~ 
    scale(test_clean) * timepoint +
    (1 | ELS_ID),
  data = cd_clean_interval
)

t1t2_mod2_tp_mf2_test <- lmer(
  scale(cort_clean) ~ 
    scale(test_clean) * timepoint +
    interval_yr +
    (1 | ELS_ID),
  data = cd_clean_interval
)

anova(t1t2_mod1_int_test, t1t2_mod2_tp_mf2_test)

# medication________________________________

t1t2_mod_tp_mf3_test <- lmer(
  scale(cort_clean) ~ 
    scale(test_clean) * timepoint +
    medication_binary +
    (1 | ELS_ID),
  data = cd_clean
)
    
anova(t1t2_mod1_tp_test, t1t2_mod_tp_mf3_test)

# sex________________________________________
t1t2_mod_tp_mf4_test <- lmer(
  scale(cort_clean) ~ 
    scale(test_clean) * timepoint +
    male +
    (1 | ELS_ID),
  data = cd_clean
)
    
anova(t1t2_mod1_tp_test, t1t2_mod_tp_mf4_test)

# bmi T1______________________________________
t1t2_mod2_bmi_test <- lmer(
  scale(cort_clean) ~ 
    scale(test_clean) * timepoint +
    (1 | ELS_ID),
  data = cd_clean_bmi
)

t1t2_mod_tp_mf5_test <- lmer(
  scale(cort_clean) ~ 
    scale(test_clean) * timepoint +
    scale(bmi_t1) +
    (1 | ELS_ID),
  data = cd_clean_bmi
)
    
anova(t1t2_mod2_bmi_test, t1t2_mod_tp_mf5_test)

# age________________________________________

t1t2_mod2_age_test <- lmer(
  scale(cort_clean) ~ 
    scale(test_clean) * timepoint +
    (1 | ELS_ID),
  data = cd_clean_age
)

t1t2_mod_tp_mf6_test <- lmer(
  scale(cort_clean) ~ 
    scale(test_clean) * timepoint +
    scale(child_age_t1) +
    (1 | ELS_ID),
  data = cd_clean_age
)
    
anova(t1t2_mod2_age_test, t1t2_mod_tp_mf6_test)
```


```{r t1t2mod_test, warning=FALSE, include=FALSE}
contrasts(cd_clean$timepoint) = c(0, 1) # T1 is baseline

t1t2_mod1_tp_test <- lmer(
  scale(cort_clean) ~ 
    scale(test_clean) * timepoint +
    (1 | ELS_ID),
  data = cd_clean
)

summary(t1t2_mod1_tp_test)
confint.merMod(t1t2_mod1_tp_test, method = "boot")

contrasts(cd_clean$timepoint) = c(1, 0) # 2 is baseline

t1t2_mod2_tp_test <- lmer(
  scale(cort_clean) ~ 
    scale(test_clean) * timepoint +
    (1 | ELS_ID),
  data = cd_clean
)

summary(t1t2_mod2_tp_test)
confint.merMod(t1t2_mod2_tp_test, method = "boot")
```
Results of a multi-level model indicated that testosterone did not interact with time point (dummy-coded) to explain cortisol (β=-0.05, SE=0.11, _t_(236.23)=-0.44, _p_=.664, 95% CI[-0.27, 0.17]). Results of formal model fitting indicated that interval in years between T1 and T2, use of medication, BMI, and child age at T1 did not improved model fit; however, time of collection and sex significantly improved model fit. Results were highly similar in sensitivity analyses controlling for time of collection and sex, in analyses excluding hormone values that were collected contemporaenous with the use of corticosteroids, and separate models conducted in boys and girls respectively. We present the simple associations between testosterone and cortisol at T1 and T2 for each sex in Figure 2. 



```{r t1t2mod_sensitivity_test, warning=FALSE, include=FALSE}
contrasts(cd_clean$timepoint) = c(0, 1) # T1 is baseline
contrasts(cd_clean$male) = c(-1, 1) # effect code sex

t1t2_mod1_tp_sens_test <- lmer(
  scale(cort_clean) ~ 
    scale(test_clean) * timepoint +
    scale(time_collection) +
    male +
    (1 | ELS_ID),
  data = cd_clean
)

summary(t1t2_mod1_tp_sens_test)

#confint.merMod(t1t2_mod1_tp_sens_test, method = "boot")
```

```{r t1t2mod_corticosterid_test, warning=FALSE, include=FALSE}
contrasts(cd_clean_nosteroid$timepoint) = c(0, 1) # T1 is baseline

t1t2_mod1_nosteroid <- lmer(
  scale(cort_clean) ~ 
    scale(test_clean) * timepoint +
    (1 | ELS_ID),
  data = cd_clean_nosteroid
)

summary(t1t2_mod1_nosteroid)

#confint.merMod(t1t2_mod1_nosteroid, method = "boot")

```

```{r t1t2mod_bysex_test, warning=FALSE, include=FALSE}
contrasts(cd_clean_boys$timepoint) = c(0, 1) # T1 is baseline

t1t2_mod1_tp_boys_test <- lmer(
  scale(cort_clean) ~ 
    scale(test_clean) * timepoint +
    (1 | ELS_ID),
  data = cd_clean_boys
)

summary(t1t2_mod1_tp_boys_test)

t1t2_mod1_tp_girls_test <- lmer(
  scale(cort_clean) ~ 
    scale(test_clean) * timepoint +
    (1 | ELS_ID),
  data = cd_clean_girls
)

summary(t1t2_mod1_tp_girls_test)

#confint.merMod(t1t2_mod1_tp_girls, method = "boot")
```

```{r plot_t1t2_mod_test, warning=FALSE}
cd_clean %>% 
  ggplot(
    aes(
      test_clean,
      cort_clean,
      color = timepoint
    )
  ) + 
  geom_point(size = 1.5, alpha = 1/2) +
  geom_smooth(method = "lm", se = FALSE, size = 1.5) +
  scale_x_continuous(breaks = seq.int(1, 8, 1), expand = c(0, 1)) +
  scale_y_continuous(breaks = seq.int(-4, 1, 1), expand = c(0, 1)) +
  scale_color_manual(
    values = c("darkblue", "darkred"),
    labels = c("T1 (earlier puberty)", "T2 (later puberty)")
  ) +
  theme_apa(box = TRUE) +
  theme(legend.position = "bottom") +
  labs(
    color = NULL,
    x = "log Testosterone (pg/mL)",
    y = "log Cortisol (µg/dL)"
  ) +
  facet_wrap(
    .~ male, 
    scales = "free",
    labeller = labeller(male = c("0" = "Girls", "1" = "Boys"))
  )

```

## Association of changes in DHEA from T1 to T2 with changes in cortisol from T1 to T2
```{r coupling_me_modelfit, include=FALSE}

contrasts(cd_wf_clean$male) = c(-1, 1) #effect code sex
contrasts(cd_wf_clean$medication_t1) = c(-1, 1) # effect code medication
contrasts(cd_wf_clean$medication_t2) = c(-1, 1) # effect code medication

coupling_mod1_me <- lm(
  scale(cort_slope_yr) ~ 
    scale(dhea_slope_yr_win) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1),
  data = cd_wf_clean
)

# time of collection at t1______________________
cd_wf_clean_time_t1 <-
  cd_wf_clean %>% 
  filter(!is.na(time_collection_t1))

coupling_mod1_time_t1_me <- lm(
  scale(cort_slope_yr) ~ 
    scale(dhea_slope_yr_win) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1),
  data = cd_wf_clean_time_t1
)

coupling_mod_time_t1_me <- lm(
  scale(cort_slope_yr) ~
    scale(dhea_slope_yr_win) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1) +
    scale(time_collection_t1),
  data = cd_wf_clean_time_t1
)

anova(coupling_mod1_time_t1_me, coupling_mod_time_t1_me)

# time of collection at t2______________________
cd_wf_clean_time_t2 <-
  cd_wf_clean %>% 
  filter(!is.na(time_collection_t2))

coupling_mod1_time_t2_me <- lm(
  scale(cort_slope_yr) ~
    scale(dhea_slope_yr_win) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1),
  data = cd_wf_clean_time_t2
)

coupling_mod_time_t2_me <- lm(
  scale(cort_slope_yr) ~
    scale(dhea_slope_yr_win) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1) +
    scale(time_collection_t2),
  data = cd_wf_clean_time_t2
)

anova(coupling_mod1_time_t2_me, coupling_mod_time_t2_me)

# medication at t1_____________________________ 
coupling_mod_med_t1_me <- lm(
  scale(cort_slope_yr) ~
    scale(dhea_slope_yr_win) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1) +
    medication_t1,
  data = cd_wf_clean
)

anova(coupling_mod1_me, coupling_mod_med_t1_me)


# medication at t2_____________________________ 
coupling_mod_med_t2_me <- lm(
  scale(cort_slope_yr) ~
    scale(dhea_slope_yr_win) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1) +
    medication_t2,
  data = cd_wf_clean
)

anova(coupling_mod1_me, coupling_mod_med_t2_me)


# sex_________________________________________ 
coupling_mod_sex_me <- lm(
  scale(cort_slope_yr) ~
    scale(dhea_slope_yr_win) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1) +
    male,
  data = cd_wf_clean
)

anova(coupling_mod1_me, coupling_mod_sex_me)


# child age at t1______________________________
coupling_mod_age_me <- lm(
  scale(cort_slope_yr) ~
    scale(dhea_slope_yr_win) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1) +
    scale(child_age_t1),
  data = cd_wf_clean
)

anova(coupling_mod1_me, coupling_mod_age_me)

# bmi at t1______________________________
cd_wf_clean_bmi <-
  cd_wf_clean %>% 
  filter(!is.na(bmi_t1))

coupling_mod1_bmi_me <- lm(
  scale(cort_slope_yr) ~
    scale(dhea_slope_yr_win) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1),
  data = cd_wf_clean_bmi
)

coupling_mod_bmi_me <- lm(
  scale(cort_slope_yr) ~
    scale(dhea_slope_yr_win) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1) +
    scale(bmi_t1),
  data = cd_wf_clean_bmi
)

anova(coupling_mod1_bmi_me, coupling_mod_bmi_me)
```

```{r coupling_me}
coupling_mod1_me_df <- format_lm_df(coupling_mod1_me)

beta_int_coupling_mod1_me <- 
  coupling_mod1_me_df$`scale(dhea_slope_yr_win)_estimate`

se_int_coupling_mod1_me <- 
  coupling_mod1_me_df$`scale(dhea_slope_yr_win)_std.error`

tstat_int_coupling_mod1_me <- 
  coupling_mod1_me_df$`scale(dhea_slope_yr_win)_statistic`

p_int_coupling_mod1_me <- 
  format_pval(
    coupling_mod1_me_df$`scale(dhea_slope_yr_win)_p.value`
  )

confint_coupling_mod1_me <- as.data.frame(confint(coupling_mod1_me))

#extract df 
df_coupling_mod_me <- 
  broom::glance(coupling_mod1_me) %>% 
  pull(df.residual)
```

```{r couple_me_r2}
coupling_mod1_base <- lm(
  scale(cort_slope_yr) ~ 
    scale(cort_clean_t1) +
    scale(dhea_clean_t1),
  data = cd_wf_clean
)

coupling_mod1_base_summary <- summary(coupling_mod1_base)
coupling_mod1_base_r2 <- coupling_mod1_base_summary$r.squared

coupling_mod1_me_summary <- summary(coupling_mod1_me)
coupling_mod1_me_r2 <- coupling_mod1_me_summary$r.squared

r2_chg_dhea_coupling <- coupling_mod1_me_r2 - coupling_mod1_base_r2
```

```{r couple_me_sensitivity}
coupling_mod_age_me <- lm(
  scale(cort_slope_yr) ~
    scale(dhea_slope_yr_win) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1) +
    scale(child_age_t1),
  data = cd_wf_clean
)

coupling_mod_age_me_df <- format_lm_df(coupling_mod_age_me)

beta_int_coupling_mod_age_me <- 
  coupling_mod_age_me_df$`scale(dhea_slope_yr_win)_estimate`

se_int_coupling_mod_age_me <- 
  coupling_mod_age_me_df$`scale(dhea_slope_yr_win)_std.error`

tstat_int_coupling_mod_age_me <- 
  coupling_mod_age_me_df$`scale(dhea_slope_yr_win)_statistic`

p_int_coupling_mod_age_me <- 
  format_pval(
    coupling_mod_age_me_df$`scale(dhea_slope_yr_win)_p.value`
  )

confint_coupling_mod_age_me <- as.data.frame(confint(coupling_mod_age_me))

#extract df 
df_coupling_mod_age_me <- 
  broom::glance(coupling_mod_age_me) %>% 
  pull(df.residual)
```

```{r coupling_me_bysex}
#boys
cd_wf_clean_boys <-
  cd_wf_clean %>% 
  filter(male == 1)

coupling_mod1_me_boys <- lm(
  scale(cort_slope_yr) ~ 
    scale(dhea_slope_yr_win) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1),
  data = cd_wf_clean_boys
)

coupling_mod1_me_boys_df <- format_lm_df(coupling_mod1_me_boys)

beta_int_coupling_mod1_me_boys <- 
  coupling_mod1_me_boys_df$`scale(dhea_slope_yr_win)_estimate`

se_int_coupling_mod1_me_boys <- 
  coupling_mod1_me_boys_df$`scale(dhea_slope_yr_win)_std.error`

tstat_int_coupling_mod1_me_boys <- 
  coupling_mod1_me_boys_df$`scale(dhea_slope_yr_win)_statistic`

p_int_coupling_mod1_me_boys <- 
  format_pval(
    coupling_mod1_me_boys_df$`scale(dhea_slope_yr_win)_p.value`
  )

confint_coupling_mod1_me_boys <- as.data.frame(confint(coupling_mod1_me_boys))

df_coupling_mod1_me_boys <- 
  broom::glance(coupling_mod1_me_boys) %>% 
  pull(df.residual)

#girls
cd_wf_clean_girls <-
  cd_wf_clean %>% 
  filter(male == 0)

coupling_mod1_me_girls <- lm(
  scale(cort_slope_yr) ~ 
    scale(dhea_slope_yr_win) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1),
  data = cd_wf_clean_girls
)

coupling_mod1_me_girls_df <- format_lm_df(coupling_mod1_me_girls)

beta_int_coupling_mod1_me_girls <- 
  coupling_mod1_me_girls_df$`scale(dhea_slope_yr_win)_estimate`

se_int_coupling_mod1_me_girls <- 
  coupling_mod1_me_girls_df$`scale(dhea_slope_yr_win)_std.error`

tstat_int_coupling_mod1_me_girls <- 
  coupling_mod1_me_girls_df$`scale(dhea_slope_yr_win)_statistic`

p_int_coupling_mod1_me_girls <- 
  format_pval(
    coupling_mod1_me_girls_df$`scale(dhea_slope_yr_win)_p.value`
  )

confint_coupling_mod1_me_girls <- as.data.frame(confint(coupling_mod1_me_girls))

df_coupling_mod1_me_girls <- 
  broom::glance(coupling_mod1_me_girls) %>% 
  pull(df.residual)

```

Results of a linear regresion model indicated that the slope of DHEA from T1 to T2 was positively associated with the slope of cortisol from T1 to T2 (β=`r beta_int_coupling_mod1_me`, SE=`r se_int_coupling_mod1_me`, _t_(`r df_coupling_mod_me`)=`r tstat_int_coupling_mod1_me`, _p_`r p_int_coupling_mod1_me`, 95% CI[`r confint_coupling_mod1_me[2,1]`, `r confint_coupling_mod1_me[2,2]`]). The slope of DHEA from T1 to T2 explain 14% of the variance in the slope of cortisol from T1 to T2, above and beyond cortisol and DHEA at T1. Results of formal model fitting indicated that age at T1 marginally improved model fit. Results were highly similar when age was included in the model (β=`r beta_int_coupling_mod1_me`, SE=`r se_int_coupling_mod_age_me`, _t_(`r df_coupling_mod_age_me`)=`r tstat_int_coupling_mod_age_me`, _p_`r p_int_coupling_mod_age_me`, 95% CI[`r confint_coupling_mod_age_me[2,1]`, `r confint_coupling_mod_age_me[2,2]`]). The slope of DHEA was positively associated with the slope of cortisol both boys and girls, although the size of the effect was somewhat larger in boys (_boys_: β=`r beta_int_coupling_mod1_me_boys`, SE=`r se_int_coupling_mod1_me_boys`, _t_(`r df_coupling_mod1_me_boys`)=`r tstat_int_coupling_mod1_me_boys`, _p_`r p_int_coupling_mod1_me_boys`, 95% CI[`r confint_coupling_mod1_me_boys[2,1]`, `r confint_coupling_mod1_me_boys[2,2]`]; _girls_: β=`r beta_int_coupling_mod1_me_girls`, SE=`r se_int_coupling_mod1_me_girls`, _t_(`r df_coupling_mod1_me_girls`)=`r tstat_int_coupling_mod1_me_girls`, _p_`r p_int_coupling_mod1_me_girls`, 95% CI[`r confint_coupling_mod1_me_girls[2,1]`, `r confint_coupling_mod1_me_girls[2,2]`])

## Association of changes in testosterone from T1 to T2 with changes in cortisol from T1 to T2
```{r coupling_me_test_modelfit, include=FALSE}

contrasts(cd_wf_clean$male) = c(-1, 1) #effect code sex
contrasts(cd_wf_clean$medication_t1) = c(-1, 1) # effect code medication
contrasts(cd_wf_clean$medication_t2) = c(-1, 1) # effect code medication

coupling_mod1_test_me <- lm(
  scale(cort_slope_yr) ~ 
    scale(test_slope_yr_win) +
    scale(cort_clean_t1) +
    scale(test_clean_t1),
  data = cd_wf_clean
)

# time of collection at t1______________________
coupling_mod1_time_t1_test_me <- lm(
  scale(cort_slope_yr) ~ 
    scale(test_slope_yr_win) +
    scale(cort_clean_t1) +
    scale(test_clean_t1),
  data = cd_wf_clean_time_t1
)

coupling_mod_time_t1_test_me <- lm(
  scale(cort_slope_yr) ~
    scale(test_slope_yr_win) +
    scale(cort_clean_t1) +
    scale(test_clean_t1) +
    scale(time_collection_t1),
  data = cd_wf_clean_time_t1
)

anova(coupling_mod1_time_t1_test_me, coupling_mod_time_t1_test_me)

# time of collection at t2______________________
coupling_mod1_time_t2_test_me <- lm(
  scale(cort_slope_yr) ~
    scale(test_slope_yr_win) +
    scale(cort_clean_t1) +
    scale(test_clean_t1),
  data = cd_wf_clean_time_t2
)

coupling_mod_time_t2_test_me <- lm(
  scale(cort_slope_yr) ~
    scale(test_slope_yr_win) +
    scale(cort_clean_t1) +
    scale(test_clean_t1) +
    scale(time_collection_t2),
  data = cd_wf_clean_time_t2
)

anova(coupling_mod1_time_t2_test_me, coupling_mod_time_t2_test_me)

# medication at t1_____________________________ 
coupling_mod_med_t1_test_me <- lm(
  scale(cort_slope_yr) ~
    scale(test_slope_yr_win) +
    scale(cort_clean_t1) +
    scale(test_clean_t1) +
    medication_t1,
  data = cd_wf_clean
)

anova(coupling_mod1_test_me, coupling_mod_med_t1_test_me)


# medication at t2_____________________________ 
coupling_mod_med_t2_test_me <- lm(
  scale(cort_slope_yr) ~
    scale(test_slope_yr_win) +
    scale(cort_clean_t1) +
    scale(test_clean_t1) +
    medication_t2,
  data = cd_wf_clean
)

anova(coupling_mod1_test_me, coupling_mod_med_t2_test_me)


# sex_________________________________________ 
coupling_mod_sex_test_me <- lm(
  scale(cort_slope_yr) ~
    scale(test_slope_yr_win) +
    scale(cort_clean_t1) +
    scale(test_clean_t1) +
    male,
  data = cd_wf_clean
)

anova(coupling_mod1_test_me, coupling_mod_sex_test_me)


# child age at t1______________________________
coupling_mod_age_test_me <- lm(
  scale(cort_slope_yr) ~
    scale(test_slope_yr_win) +
    scale(cort_clean_t1) +
    scale(test_clean_t1) +
    scale(child_age_t1),
  data = cd_wf_clean
)

anova(coupling_mod1_test_me, coupling_mod_age_test_me)

# bmi at t1______________________________
coupling_mod1_bmi_test_me <- lm(
  scale(cort_slope_yr) ~
    scale(test_slope_yr_win) +
    scale(cort_clean_t1) +
    scale(test_clean_t1),
  data = cd_wf_clean_bmi
)

coupling_mod_bmi_test_me <- lm(
  scale(cort_slope_yr) ~
    scale(test_slope_yr_win) +
    scale(cort_clean_t1) +
    scale(test_clean_t1) +
    scale(bmi_t1),
  data = cd_wf_clean_bmi
)

anova(coupling_mod1_bmi_test_me, coupling_mod_bmi_test_me)
```

```{r coupling_test_me}
coupling_mod1_me_test_df <- format_lm_df(coupling_mod1_test_me)

beta_int_coupling_mod1_test_me <- 
  coupling_mod1_me_test_df$`scale(test_slope_yr_win)_estimate`

se_int_coupling_mod1_test_me <- 
  coupling_mod1_me_test_df$`scale(test_slope_yr_win)_std.error`

tstat_int_coupling_mod1_test_me <- 
  coupling_mod1_me_test_df$`scale(test_slope_yr_win)_statistic`

p_int_coupling_mod1_test_me <- 
  format_pval(
    coupling_mod1_me_test_df$`scale(test_slope_yr_win)_p.value`
  )

confint_coupling_mod1_test_me <- as.data.frame(confint(coupling_mod1_test_me))

#extract df 
df_coupling_mod_test_me <- 
  broom::glance(coupling_mod1_test_me) %>% 
  pull(df.residual)
```

```{r couple_test_me_r2}
coupling_mod1_base_test <- lm(
  scale(cort_slope_yr) ~ 
    scale(cort_clean_t1) +
    scale(test_clean_t1),
  data = cd_wf_clean
)

coupling_mod1_base_test_summary <- summary(coupling_mod1_base_test)
coupling_mod1_base_test_r2 <- coupling_mod1_base_test_summary$r.squared

coupling_mod1_test_me_summary <- summary(coupling_mod1_test_me)
coupling_mod1_test_me_r2 <- coupling_mod1_test_me_summary$r.squared

r2_chg_test_coupling <- coupling_mod1_test_me_r2 - coupling_mod1_base_test_r2
```

```{r coupling_test_me_bysex}
#boys
coupling_mod1_test_me_boys <- lm(
  scale(cort_slope_yr) ~ 
    scale(test_slope_yr_win) +
    scale(cort_clean_t1) +
    scale(test_clean_t1),
  data = cd_wf_clean_boys
)

coupling_mod1_test_me_boys_df <- format_lm_df(coupling_mod1_test_me_boys)

beta_int_coupling_mod1_test_me_boys <- 
  coupling_mod1_test_me_boys_df$`scale(test_slope_yr_win)_estimate`

se_int_coupling_mod1_test_me_boys <- 
  coupling_mod1_test_me_boys_df$`scale(test_slope_yr_win)_std.error`

tstat_int_coupling_mod1_test_me_boys <- 
  coupling_mod1_test_me_boys_df$`scale(test_slope_yr_win)_statistic`

p_int_coupling_mod1_test_me_boys <- 
  format_pval(
    coupling_mod1_test_me_boys_df$`scale(test_slope_yr_win)_p.value`
  )

confint_coupling_mod1_test_me_boys <- as.data.frame(confint(coupling_mod1_test_me_boys))

df_coupling_mod1_test_me_boys <- 
  broom::glance(coupling_mod1_test_me_boys) %>% 
  pull(df.residual)

#girls
coupling_mod1_test_me_girls <- lm(
  scale(cort_slope_yr) ~ 
    scale(test_slope_yr_win) +
    scale(cort_clean_t1) +
    scale(test_clean_t1),
  data = cd_wf_clean_girls
)

coupling_mod1_test_me_girls_df <- format_lm_df(coupling_mod1_test_me_girls)

beta_int_coupling_mod1_test_me_girls <- 
  coupling_mod1_test_me_girls_df$`scale(test_slope_yr_win)_estimate`

se_int_coupling_mod1_test_me_girls <- 
  coupling_mod1_test_me_girls_df$`scale(test_slope_yr_win)_std.error`

tstat_int_coupling_mod1_test_me_girls <- 
  coupling_mod1_test_me_girls_df$`scale(test_slope_yr_win)_statistic`

p_int_coupling_mod1_test_me_girls <- 
  format_pval(
    coupling_mod1_test_me_girls_df$`scale(test_slope_yr_win)_p.value`
  )

confint_coupling_mod1_test_me_girls <- as.data.frame(confint(coupling_mod1_test_me_girls))

df_coupling_mod1_test_me_girls <- 
  broom::glance(coupling_mod1_test_me_girls) %>% 
  pull(df.residual)

```

Results of a linear regresion model indicated that the slope of DHEA from T1 to T2 was positively associated with the slope of cortisol from T1 to T2 (β=`r beta_int_coupling_mod1_test_me`, SE=`r se_int_coupling_mod1_test_me`, _t_(`r df_coupling_mod_test_me`)=`r tstat_int_coupling_mod1_test_me`, _p_`r p_int_coupling_mod1_test_me`, 95% CI[`r confint_coupling_mod1_test_me[2,1]`, `r confint_coupling_mod1_test_me[2,2]`]). The slope of testosterone from T1 to T2 explain 5% of the variance in the slope of cortisol from T1 to T2, above and beyond cortisol and testosterone at T1. Results of formal model fitting indicated that none of the potential covariates improved model fit. The effect of the slope of testosterone on the slope of cortisol was highly similar in boys and girls (_boys_: β=`r beta_int_coupling_mod1_test_me_boys`, SE=`r se_int_coupling_mod1_test_me_boys`, _t_(`r df_coupling_mod1_test_me_boys`)=`r tstat_int_coupling_mod1_test_me_boys`, _p_`r p_int_coupling_mod1_test_me_boys`, 95% CI[`r confint_coupling_mod1_test_me_boys[2,1]`, `r confint_coupling_mod1_test_me_boys[2,2]`]; _girls_: β=`r beta_int_coupling_mod1_test_me_girls`, SE=`r se_int_coupling_mod1_test_me_girls`, _t_(`r df_coupling_mod1_test_me_girls`)=`r tstat_int_coupling_mod1_test_me_girls`, _p_`r p_int_coupling_mod1_test_me_girls`, 95% CI[`r confint_coupling_mod1_test_me_girls[2,1]`, `r confint_coupling_mod1_test_me_girls[2,2]`]).

## Association of threat severity with longitudinal coupling of DHEA and cortisol across the pubertal transition

```{r coupling_sensitivity, include=FALSE}
contrasts(cd_wf_clean$male) = c(-1, 1) #effect code sex
contrasts(cd_wf_clean$medication_t1) = c(-1, 1) # effect code medication
contrasts(cd_wf_clean$medication_t2) = c(-1, 1) # effect code medication

coupling_mod1 <- lm(
  scale(cort_slope_yr) ~ 
    scale(dhea_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1),
  data = cd_wf_clean
)

# time of collection at t1______________________
cd_wf_clean_time_t1 <-
  cd_wf_clean %>% 
  filter(!is.na(time_collection_t1))

coupling_mod1_time_t1 <- lm(
  scale(cort_slope_yr) ~ 
    scale(dhea_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1),
  data = cd_wf_clean_time_t1
)

coupling_mod_time_t1 <- lm(
  scale(cort_slope_yr) ~
    scale(dhea_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1) +
    scale(time_collection_t1),
  data = cd_wf_clean_time_t1
)

anova(coupling_mod1_time_t1, coupling_mod_time_t1)

# time of collection at t2______________________
cd_wf_clean_time_t2 <-
  cd_wf_clean %>% 
  filter(!is.na(time_collection_t2))

coupling_mod1_time_t2 <- lm(
  scale(cort_slope_yr) ~
    scale(dhea_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1),
  data = cd_wf_clean_time_t2
)

coupling_mod_time_t2 <- lm(
  scale(cort_slope_yr) ~
    scale(dhea_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1) +
    scale(time_collection_t2),
  data = cd_wf_clean_time_t2
)

anova(coupling_mod1_time_t2, coupling_mod_time_t2)

# medication at t1_____________________________ 
coupling_mod_med_t1 <- lm(
  scale(cort_slope_yr) ~
    scale(dhea_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1) +
    medication_t1,
  data = cd_wf_clean
)

anova(coupling_mod1, coupling_mod_med_t1)


# medication at t2_____________________________ 
coupling_mod_med_t2 <- lm(
  scale(cort_slope_yr) ~
    scale(dhea_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1) +
    medication_t2,
  data = cd_wf_clean
)

anova(coupling_mod1, coupling_mod_med_t2)


# sex_________________________________________ 
coupling_mod_sex <- lm(
  scale(cort_slope_yr) ~
    scale(dhea_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1) +
    male,
  data = cd_wf_clean
)

anova(coupling_mod1, coupling_mod_sex)


# child age at t1______________________________
coupling_mod_age <- lm(
  scale(cort_slope_yr) ~
    scale(dhea_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1) +
    scale(child_age_t1),
  data = cd_wf_clean
)

anova(coupling_mod1, coupling_mod_age)

# bmi at t1______________________________
cd_wf_clean_bmi <-
  cd_wf_clean %>% 
  filter(!is.na(bmi_t1))

coupling_mod1_bmi <- lm(
  scale(cort_slope_yr) ~
    scale(dhea_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1),
  data = cd_wf_clean_bmi
)

coupling_mod_bmi <- lm(
  scale(cort_slope_yr) ~
    scale(dhea_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1) +
    scale(bmi_t1),
  data = cd_wf_clean_bmi
)

anova(coupling_mod1_bmi, coupling_mod_bmi)

# threat at t2_____________________________
cd_wf_clean_threat_t2 <-
  cd_wf_clean %>% 
  filter(!is.na(sumsev_threat_t2))

coupling_mod1_threat_t2 <- lm(
  scale(cort_slope_yr) ~
    scale(dhea_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1),
  data = cd_wf_clean_threat_t2
)

coupling_mod_threat <- lm(
  scale(cort_slope_yr) ~
    scale(dhea_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1) +
    scale(sumsev_threat_t2),
  data = cd_wf_clean_threat_t2
)
```

```{r coupling_threatcent}
#threat is centered
coupling_mod1 <- lm(
  scale(cort_slope_yr) ~ 
    scale(dhea_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1),
  data = cd_wf_clean
)

coupling_mod1_test <- lm(
  scale(cort_slope_yr) ~ 
    scale(dhea_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(test_slope_yr_win) +
    scale(test_clean_t1) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1),
  data = cd_wf_clean
)

coupling_mod1_df <- format_lm_df(coupling_mod1)

beta_int_coupling_mod1 <- 
  coupling_mod1_df$`scale(dhea_slope_yr_win):scale(sumsev_threat_t1)_estimate`

se_int_coupling_mod1 <- 
  coupling_mod1_df$`scale(dhea_slope_yr_win):scale(sumsev_threat_t1)_std.error`

tstat_int_coupling_mod1 <- 
  coupling_mod1_df$`scale(dhea_slope_yr_win):scale(sumsev_threat_t1)_statistic`

p_int_coupling_mod1 <- 
  format_pval(
    coupling_mod1_df$`scale(dhea_slope_yr_win):scale(sumsev_threat_t1)_p.value`
  )

confint_coupling_mod1 <- as.data.frame(confint(coupling_mod1))

#extract df 
df_coupling_mod <- 
  broom::glance(coupling_mod1) %>% 
  pull(df.residual)
```

```{r r2_coupling_threat}
coupling_mod1_summary <- summary(coupling_mod1)
coupling_mod1_r2 <- coupling_mod1_summary$r.squared

r2_chg_threat_dhea_coupling <- coupling_mod1_r2 - coupling_mod1_me_r2
```


```{r coupling_threatlo}
# threat - 1SD of mean (low)
coupling_mod_lo <- lm(
  scale(cort_slope_yr) ~ 
    scale(dhea_slope_yr_win) * 
    I(scale(sumsev_threat_t1) + sd(scale(sumsev_threat_t1), na.rm = TRUE)) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1),
  data = cd_wf_clean
)

#coerce model to data frame and save t and p vals
coupling_mod_lo_df <- format_lm_df(coupling_mod_lo)

beta_dhea_coupling_mod_lo <- 
  coupling_mod_lo_df$`scale(dhea_slope_yr_win)_estimate`

se_dhea_coupling_mod_lo <- 
  coupling_mod_lo_df$`scale(dhea_slope_yr_win)_std.error`

tstat_dhea_coupling_mod_lo <- 
  coupling_mod_lo_df$`scale(dhea_slope_yr_win)_statistic`

p_dhea_coupling_mod_lo <- 
  format_pval(
    coupling_mod_lo_df$`scale(dhea_slope_yr_win)_p.value`
  )

confint_coupling_mod_lo <- as.data.frame(confint(coupling_mod_lo))
```

```{r coupling_threathi}
# threat + 1 SD of mean (high)
coupling_mod_hi <- lm(
    scale(cort_slope_yr) ~ 
    scale(dhea_slope_yr_win) * 
    I(scale(sumsev_threat_t1) - sd(scale(sumsev_threat_t1), na.rm = TRUE)) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1),
  data = cd_wf_clean
)

coupling_mod_hi_df <- format_lm_df(coupling_mod_hi)

beta_dhea_coupling_mod_hi <- 
  coupling_mod_hi_df$`scale(dhea_slope_yr_win)_estimate`

se_dhea_coupling_mod_hi <- 
  coupling_mod_hi_df$`scale(dhea_slope_yr_win)_std.error`

tstat_dhea_coupling_mod_hi <- 
  coupling_mod_hi_df$`scale(dhea_slope_yr_win)_statistic`

p_dhea_coupling_mod_hi <- 
  format_pval(
    coupling_mod_hi_df$`scale(dhea_slope_yr_win)_p.value`
  )

confint_coupling_mod_hi <- as.data.frame(confint(coupling_mod_hi))
```


```{r coupling_corticosteroid}
cd_wf_clean_nosteroid <-
  cd_wf_clean %>% 
  filter(
    corticosteroid_t1 == 0,
    corticosteroid_t2 == 0
  )

#threat is centered
coupling_mod1_nosteroid <- lm(
   scale(cort_slope_yr) ~ 
    scale(dhea_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1),
  data = cd_wf_clean_nosteroid
)

coupling_mod1_nosteroid_df <- format_lm_df(coupling_mod1_nosteroid)

beta_int_coupling_mod1_nosteroid <- 
  coupling_mod1_nosteroid_df$`scale(dhea_slope_yr_win):scale(sumsev_threat_t1)_estimate`

se_int_coupling_mod1_nosteroid <- 
  coupling_mod1_nosteroid_df$`scale(dhea_slope_yr_win):scale(sumsev_threat_t1)_std.error`

tstat_int_coupling_mod1_nosteroid <- 
  coupling_mod1_nosteroid_df$`scale(dhea_slope_yr_win):scale(sumsev_threat_t1)_statistic`

p_int_coupling_mod1_nosteroid <- 
  format_pval(
    coupling_mod1_nosteroid_df$`scale(dhea_slope_yr_win):scale(sumsev_threat_t1)_p.value`
  )

confint_coupling_mod1_nosteroid <- as.data.frame(confint(coupling_mod1_nosteroid))

#extract df 
df_coupling_mod_nosteroid <- 
  broom::glance(coupling_mod1_nosteroid) %>% 
  pull(df.residual)
```

```{r coupling_bysex}
#boys
coupling_mod1_boys <- lm(
  scale(cort_slope_yr) ~ 
    scale(dhea_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1),
  data = cd_wf_clean_boys
)

coupling_mod1_boys_df <- format_lm_df(coupling_mod1_boys)

beta_coupling_mod1_boys <- 
  coupling_mod1_boys_df$`scale(dhea_slope_yr_win):scale(sumsev_threat_t1)_estimate`

se_int_coupling_mod1_boys <- 
  coupling_mod1_boys_df$`scale(dhea_slope_yr_win):scale(sumsev_threat_t1)_std.error`

tstat_int_coupling_mod1_boys <- 
  coupling_mod1_boys_df$`scale(dhea_slope_yr_win):scale(sumsev_threat_t1)_statistic`

p_int_coupling_mod1_boys <- 
  format_pval(
    coupling_mod1_boys_df$`scale(dhea_slope_yr_win):scale(sumsev_threat_t1)_p.value`
  )

confint_coupling_mod1_boys <- as.data.frame(confint(coupling_mod1_boys))

#girls
coupling_mod1_girls <- lm(
  scale(cort_slope_yr) ~ 
    scale(dhea_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(dhea_clean_t1),
  data = cd_wf_clean_girls
)

coupling_mod1_girls_df <- format_lm_df(coupling_mod1_girls)

beta_coupling_mod1_girls <- 
  coupling_mod1_girls_df$`scale(dhea_slope_yr_win):scale(sumsev_threat_t1)_estimate`

se_int_coupling_mod1_girls <- 
  coupling_mod1_girls_df$`scale(dhea_slope_yr_win):scale(sumsev_threat_t1)_std.error`

tstat_int_coupling_mod1_girls <- 
  coupling_mod1_girls_df$`scale(dhea_slope_yr_win):scale(sumsev_threat_t1)_statistic`

p_int_coupling_mod1_girls <- 
  format_pval(
    coupling_mod1_girls_df$`scale(dhea_slope_yr_win):scale(sumsev_threat_t1)_p.value`
  )

confint_coupling_mod1_girls <- as.data.frame(confint(coupling_mod1_girls))

```

Results of a linear regresion model indicated that threat severity interacted with the slope of DHEA from T1 to T2 to explain the slope of cortisol from T1 to T2 (β=`r beta_int_coupling_mod1`, SE=`r se_int_coupling_mod1`, _t_(`r df_coupling_mod`)=`r tstat_int_coupling_mod1`, _p_`r p_int_coupling_mod1`, 95% CI[`r confint_coupling_mod1[6,1]`, `r confint_coupling_mod1[6,2]`]). Simple effects analyses at +/- 1SD of the mean of threat severity indicated that increases in DHEA from T1 to T2 were more strongly associated with increases in cortisol from T1 to T2 among adolescents with lower levels of threat severity (β=`r beta_dhea_coupling_mod_lo`, SE=`r se_dhea_coupling_mod_lo`, _t_(`r df_coupling_mod`)=`r tstat_dhea_coupling_mod_lo`, _p_`r p_dhea_coupling_mod_lo`, 95% CI[`r confint_coupling_mod_lo[2,1]`, `r confint_coupling_mod_lo[2,2]`]) than among adolescents with higher levels of threat severity (β=`r beta_dhea_coupling_mod_hi`, SE=`r se_dhea_coupling_mod_hi`, _t_(`r df_coupling_mod`)=`r tstat_dhea_coupling_mod_hi`, _p_`r p_dhea_coupling_mod_hi`, 95% CI[`r confint_coupling_mod_hi[2,1]`, `r confint_coupling_mod_hi[2,2]`]).

Results of formal model fitting indicated that none of the potential covariates  improved model fit.In a separate model excluding adolescents who reported use of corticoteroids at T1 or T2, the interaction between DHEA and threat severity remained significant (β=`r beta_int_coupling_mod1_nosteroid`, SE=`r se_int_coupling_mod1_nosteroid`, _t_(`r df_coupling_mod_nosteroid`)=`r tstat_int_coupling_mod1_nosteroid`, _p_`r p_int_coupling_mod1_nosteroid`, 95% CI[`r confint_coupling_mod1_nosteroid[6,1]`, `r confint_coupling_mod1_nosteroid[6,2]`]).

In separate models conducted within boys and girls respectively, the estimates for the interactions between DHEA and threat severity remained similar in effect size (__boys:__ β=`r beta_coupling_mod1_boys`, SE=`r se_int_coupling_mod1_boys`, 95% CI[`r confint_coupling_mod1_boys[6,1]`, `r confint_coupling_mod1_boys[6,2]`]; __girls:__ β=`r beta_coupling_mod1_girls`, SE=`r se_int_coupling_mod1_girls`, 95% CI[`r confint_coupling_mod1_girls[6,1]`, `r confint_coupling_mod1_girls[6,2]`]), although the effect was somewhat smaller in boys than in girls. We present the simple associations between the slopes of DHEA and cortisol at lower, mean and higher levels of threat severity in Figure 2. 

```{r plot_coupling_mod, warning=FALSE, fig.height=3, fig.width=6}
#extract model residuals for plotting
coupling_mod1_resid <- lm(
  scale(cort_slope_yr) ~ 
    scale(cort_clean_t1) +
    scale(dhea_clean_t1),
  data = cd_wf_clean
)

cd_wf_clean <-
  cd_wf_clean %>% 
  add_residuals(coupling_mod1_resid, var = "cort_slope_resid")

#save intercepts and slopes
slope_threat_cent <- 
  coupling_mod1_df$`scale(dhea_slope_yr_win)_estimate`

int_threat_cent <-
  coupling_mod1_df$`(Intercept)_estimate`

slope_threat_lo <- 
  coupling_mod_lo_df$`scale(dhea_slope_yr_win)_estimate`

int_threat_lo <-
  coupling_mod_lo_df$`(Intercept)_estimate`

slope_threat_hi <- 
  coupling_mod_hi_df$`scale(dhea_slope_yr_win)_estimate`

int_threat_hi <-
  coupling_mod_hi_df$`(Intercept)_estimate`

int_slope_df <-
  tibble(
  "Threat" = c("b", "a"),
  "Intercept" = c(int_threat_hi, int_threat_lo),
  "Slope" = c(slope_threat_hi, slope_threat_lo)
)

## plot 
cd_wf_clean %>% 
  ggplot(
    aes(
      dhea_slope_yr_win, 
      cort_slope_resid
    )
  ) +
  geom_point(size = 2, alpha = 1/2, aes(shape = male)) +
  geom_abline(
    data = int_slope_df,
    aes(
      intercept = Intercept,
      slope = Slope,
      color = Threat
    ),
    size = 2
  ) +
  scale_shape_manual(
    labels = NULL,
    values = c(2, 1)
  ) +
  guides(shape = FALSE) +
  scale_color_manual(
    labels = c("Lower (-1SD)", "Higher (+1SD)"),
    values = c("darkblue", "darkred")
  ) +
  scale_y_continuous(breaks = seq.int(-2, 2.5, .5)) +
  labs(
    shape = NULL,
    color = "Threat severity",
    x = "log DHEA slope from T1 to T2",
    y = "log Cortisol slope from T1 to T2\n(standardized residuals)"
  ) 
```

## Association of threat severity with longitudinal coupling of testosterone and cortisol across the pubertal transition

```{r coupling_sensitivity_test, include=FALSE}
contrasts(cd_wf_clean$male) = c(-1, 1) #effect code sex
contrasts(cd_wf_clean$medication_t1) = c(-1, 1) # effect code medication
contrasts(cd_wf_clean$medication_t2) = c(-1, 1) # effect code medication

coupling_mod1_test <- lm(
  scale(cort_slope_yr) ~ 
    scale(test_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(test_clean_t1),
  data = cd_wf_clean
)

# time of collection at t1______________________
coupling_mod1_time_t1_test <- lm(
  scale(cort_slope_yr) ~ 
    scale(test_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(test_clean_t1),
  data = cd_wf_clean_time_t1
)

coupling_mod_time_t1_test <- lm(
  scale(cort_slope_yr) ~
    scale(test_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(test_clean_t1) +
    scale(time_collection_t1),
  data = cd_wf_clean_time_t1
)

anova(coupling_mod1_time_t1_test, coupling_mod_time_t1_test)

# time of collection at t2______________________
coupling_mod1_time_t2_test <- lm(
  scale(cort_slope_yr) ~
    scale(test_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(test_clean_t1),
  data = cd_wf_clean_time_t2
)

coupling_mod_time_t2_test <- lm(
  scale(cort_slope_yr) ~
    scale(test_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(test_clean_t1) +
    scale(time_collection_t2),
  data = cd_wf_clean_time_t2
)

anova(coupling_mod1_time_t2_test, coupling_mod_time_t2_test)

# medication at t1_____________________________ 
coupling_mod_med_t1_test <- lm(
  scale(cort_slope_yr) ~
    scale(test_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(test_clean_t1) +
    medication_t1,
  data = cd_wf_clean
)

anova(coupling_mod1_test, coupling_mod_med_t1_test)


# medication at t2_____________________________ 
coupling_mod_med_t2_test <- lm(
  scale(cort_slope_yr) ~
    scale(test_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(test_clean_t1) +
    medication_t2,
  data = cd_wf_clean
)

anova(coupling_mod1_test, coupling_mod_med_t2_test)


# sex_________________________________________ 
coupling_mod_sex_test <- lm(
  scale(cort_slope_yr) ~
    scale(test_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(test_clean_t1) +
    male,
  data = cd_wf_clean
)

anova(coupling_mod1_test, coupling_mod_sex_test)


# child age at t1______________________________
coupling_mod_age_test <- lm(
  scale(cort_slope_yr) ~
    scale(test_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(test_clean_t1) +
    scale(child_age_t1),
  data = cd_wf_clean
)

anova(coupling_mod1_test, coupling_mod_age_test)

# bmi at t1______________________________
coupling_mod1_bmi_test <- lm(
  scale(cort_slope_yr) ~
    scale(test_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(test_clean_t1),
  data = cd_wf_clean_bmi
)

coupling_mod_bmi_test <- lm(
  scale(cort_slope_yr) ~
    scale(test_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(test_clean_t1) +
    scale(bmi_t1),
  data = cd_wf_clean_bmi
)

anova(coupling_mod1_bmi_test, coupling_mod_bmi_test)

# threat at t2_____________________________
coupling_mod1_threat_t2_test <- lm(
  scale(cort_slope_yr) ~
    scale(test_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(test_clean_t1),
  data = cd_wf_clean_threat_t2
)

coupling_mod_threat_test <- lm(
  scale(cort_slope_yr) ~
    scale(test_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(test_clean_t1) +
    scale(sumsev_threat_t2),
  data = cd_wf_clean_threat_t2
)

anova(coupling_mod_threat_test, coupling_mod1_threat_t2_test)
```

```{r coupling_threatcent_test}
#threat is centered
coupling_mod1_test <- lm(
  scale(cort_slope_yr) ~ 
    scale(test_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(test_clean_t1),
  data = cd_wf_clean
)

coupling_mod1_test_df <- format_lm_df(coupling_mod1_test)

# main effect
beta_testslope_coupling_mod1_test <- 
  coupling_mod1_test_df$`scale(test_slope_yr_win)_estimate`

se_testslope_coupling_mod1_test <- 
  coupling_mod1_test_df$`scale(test_slope_yr_win)_std.error`

tstat_testslope_coupling_mod1_test <- 
  coupling_mod1_test_df$`scale(test_slope_yr_win)_statistic`

p_testslope_coupling_mod1_test <- 
  format_pval(
    coupling_mod1_test_df$`scale(test_slope_yr_win)_p.value`
  )

# interaction
beta_int_coupling_mod1_test <- 
  coupling_mod1_test_df$`scale(test_slope_yr_win):scale(sumsev_threat_t1)_estimate`

se_int_coupling_mod1_test <- 
  coupling_mod1_test_df$`scale(test_slope_yr_win):scale(sumsev_threat_t1)_std.error`

tstat_int_coupling_mod1_test <- 
  coupling_mod1_test_df$`scale(test_slope_yr_win):scale(sumsev_threat_t1)_statistic`

p_int_coupling_mod1_test <- 
  format_pval(
    coupling_mod1_test_df$`scale(test_slope_yr_win):scale(sumsev_threat_t1)_p.value`
  )

confint_coupling_mod1_test <- as.data.frame(confint(coupling_mod1_test))

#extract df 
df_coupling_mod1_test <- 
  broom::glance(coupling_mod1_test) %>% 
  pull(df.residual)
```

```{r coupling_test_threatlo}
# threat - 1SD of mean (low)
coupling_mod_test_lo <- lm(
  scale(cort_slope_yr) ~ 
    scale(test_slope_yr_win) * 
    I(scale(sumsev_threat_t1) + sd(scale(sumsev_threat_t1), na.rm = TRUE)) +
    scale(cort_clean_t1) +
    scale(test_clean_t1),
  data = cd_wf_clean
)

coupling_mod_test_lo_df <- format_lm_df(coupling_mod_test_lo)
```

```{r coupling_test_threathi}
# threat + 1 SD of mean (high)
coupling_mod_test_hi <- lm(
    scale(cort_slope_yr) ~ 
    scale(test_slope_yr_win) * 
    I(scale(sumsev_threat_t1) - sd(scale(sumsev_threat_t1), na.rm = TRUE)) +
    scale(cort_clean_t1) +
    scale(test_clean_t1),
  data = cd_wf_clean
)

coupling_mod_test_hi_df <- format_lm_df(coupling_mod_test_hi)
```

```{r plot_coupling_mod_test, warning=FALSE, fig.height=3, fig.width=6}
#extract model residuals for plotting
coupling_mod1_test_resid <- lm(
  scale(cort_slope_yr) ~ 
    scale(cort_clean_t1) +
    scale(test_clean_t1),
  data = cd_wf_clean
)

cd_wf_clean <-
  cd_wf_clean %>% 
  add_residuals(coupling_mod1_test_resid, var = "cort_slope_test_resid")

#save intercepts and slopes
slope_threat_cent_test <- 
  coupling_mod1_test_df$`scale(test_slope_yr_win)_estimate`

int_threat_cent_test <-
  coupling_mod1_test_df$`(Intercept)_estimate`

slope_threat_lo_test <- 
  coupling_mod_test_lo_df$`scale(test_slope_yr_win)_estimate`

int_threat_lo_test <-
  coupling_mod_test_lo_df$`(Intercept)_estimate`

slope_threat_hi_test <- 
  coupling_mod_test_hi_df$`scale(test_slope_yr_win)_estimate`

int_threat_hi_test <-
  coupling_mod_test_hi_df$`(Intercept)_estimate`

int_slope_test_df <-
  tibble(
  "Threat" = c("b", "a"),
  "Intercept" = c(int_threat_hi_test, int_threat_lo_test),
  "Slope" = c(slope_threat_hi_test, slope_threat_lo_test)
)

## plot 
cd_wf_clean %>% 
  ggplot(
    aes(
      test_slope_yr_win, 
      cort_slope_test_resid
    )
  ) +
  geom_point(size = 2, alpha = 1/2, aes(shape = male)) +
  geom_abline(
    data = int_slope_test_df,
    aes(
      intercept = Intercept,
      slope = Slope,
      color = Threat
    ),
    size = 2
  ) +
  scale_x_continuous(breaks = seq.int(-.5, .75, .25)) +
  scale_y_continuous(breaks = seq.int(-2, 2.5, .5)) +
  scale_shape_manual(
    labels = NULL,
    values = c(2, 1)
  ) +
  guides(shape = FALSE) +
  scale_color_manual(
    labels = c("Lower (-1SD)", "Higher (+1SD)"),
    values = c("darkblue", "darkred")
  ) +
  labs(
    shape = NULL,
    color = "Threat severity",
    x = "log Testosterone slope from T1 to T2",
    y = "log Cortisol slope from T1 to T2\n(standardized residuals)"
  ) 
```

```{r coupling_corticosteroid_test, include=FALSE}
#threat is centered
coupling_mod1_nosteroid_test <- lm(
   scale(cort_slope_yr) ~ 
    scale(test_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(test_clean_t1),
  data = cd_wf_clean_nosteroid
)
```

```{r coupling_bysex_test}
#boys
coupling_mod1_boys_test <- lm(
  scale(cort_slope_yr) ~ 
    scale(test_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(test_clean_t1),
  data = cd_wf_clean_boys
)

coupling_mod1_boys_test_df <- format_lm_df(coupling_mod1_boys_test)

beta_int_coupling_mod1_boys_test <- 
  coupling_mod1_boys_test_df$`scale(test_slope_yr_win):scale(sumsev_threat_t1)_estimate`

se_int_coupling_mod1_boys_test <- 
  coupling_mod1_boys_test_df$`scale(test_slope_yr_win):scale(sumsev_threat_t1)_std.error`

tstat_int_coupling_mod1_boys_test <- 
  coupling_mod1_boys_test_df$`scale(test_slope_yr_win):scale(sumsev_threat_t1)_statistic`

p_int_coupling_mod1_boys_test <- 
  format_pval(
    coupling_mod1_boys_test_df$`scale(test_slope_yr_win):scale(sumsev_threat_t1)_p.value`
  )

confint_coupling_mod1_boys_test <- as.data.frame(confint(coupling_mod1_boys_test))

#girls
coupling_mod1_girls_test <- lm(
  scale(cort_slope_yr) ~ 
    scale(test_slope_yr_win) * 
    scale(sumsev_threat_t1) +
    scale(cort_clean_t1) +
    scale(test_clean_t1),
  data = cd_wf_clean_girls
)

coupling_mod1_girls_test_df <- format_lm_df(coupling_mod1_girls_test)

beta_coupling_mod1_girls_test <- 
  coupling_mod1_girls_test_df$`scale(test_slope_yr_win):scale(sumsev_threat_t1)_estimate`

se_int_coupling_mod1_girls_test <- 
  coupling_mod1_girls_test_df$`scale(test_slope_yr_win):scale(sumsev_threat_t1)_std.error`

tstat_int_coupling_mod1_girls_test <- 
  coupling_mod1_girls_test_df$`scale(test_slope_yr_win):scale(sumsev_threat_t1)_statistic`

p_int_coupling_mod1_girls_test <- 
  format_pval(
    coupling_mod1_girls_test_df$`scale(test_slope_yr_win):scale(sumsev_threat_t1)_p.value`
  )

confint_coupling_mod1_girls_test <- as.data.frame(confint(coupling_mod1_girls_test))
```


```{r plot_coupling_mod_test_me, warning=FALSE, fig.height=3, fig.width=6}
coupling_test_resid <- lm(
  scale(cort_slope_yr) ~ 
    scale(cort_clean_t1) +
    scale(test_clean_t1),
  data = cd_wf_clean
)

cd_wf_clean <-
  cd_wf_clean %>% 
  add_residuals(coupling_test_resid, var = "cort_slope_test_resid") 

## plot 
cd_wf_clean %>% 
  ggplot(
    aes(
      test_slope_yr_win, 
      cort_slope_test_resid
    )
  ) +
  geom_point(size = 2, alpha = 1/2, aes(shape = male)) +
  geom_smooth(method = "lm", se = FALSE, size = 2, color = "darkblue") +
  scale_shape_manual(
    labels = NULL,
    values = c(2, 1)
  ) +
  scale_y_continuous(breaks = seq.int(-2, 2.5, .5)) +
  scale_x_continuous(breaks = seq.int(-.5, 1, .25)) +
  guides(shape = FALSE) +
  labs(
    shape = NULL,
    x = "log Testosterone slope from T1 to T2",
    y = "log Cortisol slope from T1 to T2\n(standardized residuals)"
  )  
```


```{r plot_coupling_inr_mod_test, warning=FALSE, fig.height=3, fig.width=6}
coupling_test_resid_boys <- lm(
  scale(cort_slope_yr) ~ 
    scale(cort_clean_t1) +
    scale(test_clean_t1),
  data = cd_wf_clean_boys
)

coupling_test_resid_girls <- lm(
  scale(cort_slope_yr) ~ 
    scale(cort_clean_t1) +
    scale(test_clean_t1),
  data = cd_wf_clean_girls
)

cd_wf_clean <-
  cd_wf_clean %>% 
  add_residuals(coupling_test_resid_boys, var = "cort_slope_test_resid_boys") %>% 
  add_residuals(coupling_test_resid_girls, var = "cort_slope_test_resid_girls")

#save intercepts and slopes

#inr centered 
slope_inr_cent <- 
  coupling_inr_mod_df_test$`scale(test_slope_yr_win)_estimate`

int_inr_cent <- 
  coupling_inr_mod_df_test$`(Intercept)_estimate`

slope_inr_cent_boys <- 
  coupling_inr_boys_test_df$`scale(test_slope_yr_win)_estimate`

int_inr_cent_boys <-
  coupling_inr_boys_test_df$`(Intercept)_estimate`

slope_inr_cent_girls <- 
  coupling_inr_girls_test_df$`scale(test_slope_yr_win)_estimate`

int_inr_cent_girls <-
  coupling_inr_girls_test_df$`(Intercept)_estimate`

#inr low  
slope_inr_lo <- 
  coupling_inr_mod_lo_df$`scale(test_slope_yr_win)_estimate`

int_inr_lo <- 
  coupling_inr_mod_lo_df$`(Intercept)_estimate`

slope_inr_lo_boys <- 
  coupling_inr_boys_test_lo_df$`scale(test_slope_yr_win)_estimate`

int_inr_lo_boys <-
  coupling_inr_boys_test_lo_df$`(Intercept)_estimate`

slope_inr_lo_girls <- 
  coupling_inr_girls_test_lo_df$`scale(test_slope_yr_win)_estimate`

int_inr_lo_girls <-
  coupling_inr_girls_test_lo_df$`(Intercept)_estimate`


#inr high  
slope_inr_hi <- 
  coupling_inr_mod_hi_df$`scale(test_slope_yr_win)_estimate`

int_inr_hi <- 
  coupling_inr_mod_hi_df$`(Intercept)_estimate`

slope_inr_hi_boys <- 
  coupling_inr_boys_test_hi_df$`scale(test_slope_yr_win)_estimate`

int_inr_hi_boys <-
  coupling_inr_boys_test_hi_df$`(Intercept)_estimate`

slope_inr_hi_girls <- 
  coupling_inr_girls_test_hi_df$`scale(test_slope_yr_win)_estimate`

int_inr_hi_girls <-
  coupling_inr_girls_test_hi_df$`(Intercept)_estimate`

int_slope_inr_df <-
  tibble(
    "INR" = c("b", "a"),
    "Intercept" = c(int_inr_hi, int_inr_lo),
    "Slope" = c(slope_inr_hi, slope_inr_lo)
    )

intercepts_inr_bysex <- 
  c(
    int_inr_cent_boys, 
    int_inr_hi_boys, 
    int_inr_lo_boys,
    int_inr_cent_girls, 
    int_inr_hi_girls, 
    int_inr_lo_girls
  )

slopes_inr_bysex <- 
  c(
    slope_inr_cent_boys,
    slope_inr_hi_boys,
    slope_inr_lo_boys,
    slope_inr_cent_girls,
    slope_inr_hi_girls,
    slope_inr_lo_girls
  )

int_slope_inr_df_bysex <-
  tibble(
    "Sex" = c("Boys", "Boys", "Boys", "Girls", "Girls", "Girls"),
    "INR" = c("b", "c", "a", "b", "c", "a"),
    "Intercept" = intercepts_inr_bysex,
    "Slope" = slopes_inr_bysex
    )


## plot 
cd_wf_clean %>% 
  ggplot(
    aes(
      test_slope_yr_win, 
      cort_slope_test_resid
    )
  ) +
  geom_point(size = 2, alpha = 1/2, aes(shape = male)) +
  geom_abline(
    data = int_slope_inr_df,
    aes(
      intercept = Intercept,
      slope = Slope,
      color = INR
    ),
    size = 2
  ) +
  scale_shape_manual(
    labels = NULL,
    values = c(2, 1)
  ) +
  scale_color_manual(
    labels = c("Lower (-1SD)", "Higher (+1SD)"),
    values = c("darkblue", "darkred")
  ) +
  scale_y_continuous(breaks = seq.int(-2, 2.5, .5)) +
  scale_x_continuous(breaks = seq.int(-.5, 1, .25)) +
  guides(shape = FALSE) +
  labs(
    shape = NULL,
    color = "Income-to-needs ratio",
    x = "log Testosterone slope from T1 to T2",
    y = "log Cortisol slope from T1 to T2\n(standardized residuals)"
  )  
```

# Discussion


\newpage

\begingroup
\setlength{\parindent}{-0.5in}
\setlength{\leftskip}{0.5in}

<div id = "refs"></div>
\endgroup
